!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.createREGL=t()}(this,function(){"use strict";var e=function(e,t){for(var r=Object.keys(t),n=0;n<r.length;++n)e[r[n]]=t[r[n]];return e},t=0;function r(e,r){this.id=t++,this.type=e,this.data=r}function n(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function i(e){return"["+(function e(t){if(0===t.length)return[];var r=t.charAt(0),i=t.charAt(t.length-1);if(t.length>1&&r===i&&('"'===r||"'"===r))return['"'+n(t.substr(1,t.length-2))+'"'];var a=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(t);if(a)return e(t.substr(0,a.index)).concat(e(a[1])).concat(e(t.substr(a.index+a[0].length)));var f=t.split(".");if(1===f.length)return['"'+n(t)+'"'];for(var o=[],u=0;u<f.length;++u)o=o.concat(e(f[u]));return o})(e).join("][")+"]"}var a={DynamicVariable:r,define:function e(t,n){return new r(t,i(n+""))},isDynamic:function e(t){return"function"==typeof t&&!t._reglType||t instanceof r},unbox:function e(t,n){return"function"==typeof t?new r(0,t):"number"==typeof t||"boolean"==typeof t?new r(5,t):Array.isArray(t)?new r(6,t.map(function(t,r){return e(t,n+"["+r+"]")})):t instanceof r?t:void 0},accessor:i},f={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},o="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function u(e){return"string"==typeof e?e.split():e}function s(e){return"string"==typeof e?document.querySelector(e):e}function c(e,t){for(var r=Array(e),n=0;n<e;++n)r[n]=t(n);return r}function l(e){var t,r;return t=(e>65535)<<4,e>>>=t,r=(e>255)<<3,e>>>=r,t|=r,r=(e>15)<<2,e>>>=r,t|=r,r=(e>3)<<1,e>>>=r,(t|=r)|e>>1}function $(){var e=c(8,function(){return[]});function t(t){var r=function e(t){for(var r=16;r<=268435456;r*=16)if(t<=r)return r;return 0}(t),n=e[l(r)>>2];return n.length>0?n.pop():new ArrayBuffer(r)}function r(t){e[l(t.byteLength)>>2].push(t)}return{alloc:t,free:r,allocType:function e(r,n){var i=null;switch(r){case 5120:i=new Int8Array(t(n),0,n);break;case 5121:i=new Uint8Array(t(n),0,n);break;case 5122:i=new Int16Array(t(2*n),0,n);break;case 5123:i=new Uint16Array(t(2*n),0,n);break;case 5124:i=new Int32Array(t(4*n),0,n);break;case 5125:i=new Uint32Array(t(4*n),0,n);break;case 5126:i=new Float32Array(t(4*n),0,n);break;default:return null}return i.length!==n?i.subarray(0,n):i},freeType:function e(t){r(t.buffer)}}}var p=$();p.zero=$();var d=function(e,t){var r=1;t.ext_texture_filter_anisotropic&&(r=e.getParameter(34047));var n=1,i=1;t.webgl_draw_buffers&&(n=e.getParameter(34852),i=e.getParameter(36063));var a=!!t.oes_texture_float;if(a){var f=e.createTexture();e.bindTexture(3553,f),e.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var o=e.createFramebuffer();if(e.bindFramebuffer(36160,o),e.framebufferTexture2D(36160,36064,3553,f,0),e.bindTexture(3553,null),36053!==e.checkFramebufferStatus(36160))a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(16384);var u=p.allocType(5126,4);e.readPixels(0,0,1,1,6408,5126,u),e.getError()?a=!1:(e.deleteFramebuffer(o),e.deleteTexture(f),a=1===u[0]),p.freeType(u)}}var s="undefined"!=typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),c=!0;if(!s){var l=e.createTexture(),$=p.allocType(5121,36);e.activeTexture(33984),e.bindTexture(34067,l),e.texImage2D(34069,0,6408,3,3,0,6408,5121,$),p.freeType($),e.bindTexture(34067,null),e.deleteTexture(l),c=!e.getError()}return{colorBits:[e.getParameter(3410),e.getParameter(3411),e.getParameter(3412),e.getParameter(3413)],depthBits:e.getParameter(3414),stencilBits:e.getParameter(3415),subpixelBits:e.getParameter(3408),extensions:Object.keys(t).filter(function(e){return!!t[e]}),maxAnisotropic:r,maxDrawbuffers:n,maxColorAttachments:i,pointSizeDims:e.getParameter(33901),lineWidthDims:e.getParameter(33902),maxViewportDims:e.getParameter(3386),maxCombinedTextureUnits:e.getParameter(35661),maxCubeMapSize:e.getParameter(34076),maxRenderbufferSize:e.getParameter(34024),maxTextureUnits:e.getParameter(34930),maxTextureSize:e.getParameter(3379),maxAttributes:e.getParameter(34921),maxVertexUniforms:e.getParameter(36347),maxVertexTextureUnits:e.getParameter(35660),maxVaryingVectors:e.getParameter(36348),maxFragmentUniforms:e.getParameter(36349),glsl:e.getParameter(35724),renderer:e.getParameter(7937),vendor:e.getParameter(7936),version:e.getParameter(7938),readFloat:a,npotTextureCube:c}},h=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray};function m(e){return!!e&&"object"==typeof e&&Array.isArray(e.shape)&&Array.isArray(e.stride)&&"number"==typeof e.offset&&e.shape.length===e.stride.length&&(Array.isArray(e.data)||h(e.data))}var v=function(e){return Object.keys(e).map(function(t){return e[t]})},x={shape:function e(t){for(var r=[],n=t;n.length;n=n[0])r.push(n.length);return r},flatten:function e(t,r,n,i){var a=1;if(r.length)for(var f=0;f<r.length;++f)a*=r[f];else a=0;var o=i||p.allocType(n,a);switch(r.length){case 0:break;case 1:!function e(t,r,n){for(var i=0;i<r;++i)n[i]=t[i]}(t,r[0],o);break;case 2:!function e(t,r,n,i){for(var a=0,f=0;f<r;++f)for(var o=t[f],u=0;u<n;++u)i[a++]=o[u]}(t,r[0],r[1],o);break;case 3:b(t,r[0],r[1],r[2],o,0);break;default:!function e(t,r,n,i,a){for(var f=1,o=n+1;o<r.length;++o)f*=r[o];var u=r[n];if(r.length-n==4){var s=r[n+1],c=r[n+2],l=r[n+3];for(o=0;o<u;++o)b(t[o],s,c,l,i,a),a+=f}else for(o=0;o<u;++o)e(t[o],r,n+1,i,a),a+=f}(t,r,0,o,0)}return o}};function b(e,t,r,n,i,a){for(var f=a,o=0;o<t;++o)for(var u=e[o],s=0;s<r;++s)for(var c=u[s],l=0;l<n;++l)i[f++]=c[l]}var g={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},_={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},y={dynamic:35048,stream:35040,static:35044},w=x.flatten,A=x.shape,D=[];function E(e){return 0|g[Object.prototype.toString.call(e)]}function k(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function C(e,t,r,n,i,a,f){for(var o=0,u=0;u<r;++u)for(var s=0;s<n;++s)e[o++]=t[i*u+a*s+f]}D[5120]=1,D[5122]=2,D[5124]=4,D[5121]=1,D[5123]=2,D[5125]=4,D[5126]=4;var T={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},S=new Float32Array(1),F=new Uint32Array(S.buffer);function O(e){for(var t=p.allocType(5123,e.length),r=0;r<e.length;++r)if(isNaN(e[r]))t[r]=65535;else if(e[r]===1/0)t[r]=31744;else if(e[r]===-1/0)t[r]=64512;else{S[0]=e[r];var n=F[0],i=n>>>31<<15,a=(n<<1>>>24)-127,f=n>>13&1023;if(a<-24)t[r]=i;else if(a<-14){var o=-14-a;t[r]=i+(f+1024>>o)}else a>15?t[r]=i+31744:t[r]=i+(a+15<<10)+f}return t}function V(e){return Array.isArray(e)||h(e)}var B=[9984,9986,9985,9987],z=[0,6409,6410,6407,6408],j={};function I(e){return"[object "+e+"]"}j[6409]=j[6406]=j[6402]=1,j[34041]=j[6410]=2,j[6407]=j[35904]=3,j[6408]=j[35906]=4;var P=I("HTMLCanvasElement"),L=I("OffscreenCanvas"),R=I("CanvasRenderingContext2D"),M=I("ImageBitmap"),H=I("HTMLImageElement"),W=I("HTMLVideoElement"),Q=Object.keys(g).concat([P,L,R,M,H,W]),N=[];N[5121]=1,N[5126]=4,N[36193]=2,N[5123]=2,N[5125]=4;var q=[];function U(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function G(e){return!!Array.isArray(e)&&!!(0!==e.length&&V(e[0]))}function Y(e){return Object.prototype.toString.call(e)}function X(e){return Y(e)===P}function J(e){return Y(e)===L}function K(e){if(!e)return!1;var t=Y(e);return Q.indexOf(t)>=0||U(e)||G(e)||m(e)}function Z(e){return 0|g[Object.prototype.toString.call(e)]}function ee(e,t){return p.allocType(36193===e.type?5126:e.type,t)}function et(e,t){36193===e.type?(e.data=O(t),p.freeType(t)):e.data=t}function er(e,t,r,n,i,a){if(f=void 0!==q[e]?q[e]:j[e]*N[t],a&&(f*=6),!i)return f*r*n;for(var f,o=0,u=r;u>=1;)o+=f*u*u,u/=2;return o}q[32854]=2,q[32855]=2,q[36194]=2,q[34041]=4,q[33776]=.5,q[33777]=.5,q[33778]=1,q[33779]=1,q[35986]=.5,q[35987]=1,q[34798]=1,q[35840]=.5,q[35841]=.25,q[35842]=.5,q[35843]=.25,q[36196]=.5;var en=[];function ei(e,t,r){return en[e]*t*r}en[32854]=2,en[32855]=2,en[36194]=2,en[33189]=2,en[36168]=1,en[34041]=4,en[35907]=4,en[34836]=16,en[34842]=8,en[34843]=6;var ea=function(e,t,r,n,i){var a={rgba4:32854,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041};t.ext_srgb&&(a.srgba=35907),t.ext_color_buffer_half_float&&(a.rgba16f=34842,a.rgb16f=34843),t.webgl_color_buffer_float&&(a.rgba32f=34836);var f=[];Object.keys(a).forEach(function(e){f[a[e]]=e});var o=0,u={};function s(e){this.id=o++,this.refCount=1,this.renderbuffer=e,this.format=32854,this.width=0,this.height=0,i.profile&&(this.stats={size:0})}function c(t){var r=t.renderbuffer;e.bindRenderbuffer(36161,null),e.deleteRenderbuffer(r),t.renderbuffer=null,t.refCount=0,delete u[t.id],n.renderbufferCount--}return s.prototype.decRef=function(){--this.refCount<=0&&c(this)},i.profile&&(n.getTotalRenderbufferSize=function(){var e=0;return Object.keys(u).forEach(function(t){e+=u[t].stats.size}),e}),{create:function t(r,o){var c=new s(e.createRenderbuffer());function l(t,r){var n,o,u,s=0,$=0,p=32854;if("object"==typeof t&&t){var d=t;if("shape"in d){var h=d.shape;s=0|h[0],$=0|h[1]}else"radius"in d&&(s=$=0|d.radius),"width"in d&&(s=0|d.width),"height"in d&&($=0|d.height);"format"in d&&(p=a[d.format])}else"number"==typeof t?(s=0|t,$="number"==typeof r?0|r:s):t||(s=$=1);if(s!==c.width||$!==c.height||p!==c.format)return l.width=c.width=s,l.height=c.height=$,c.format=p,e.bindRenderbuffer(36161,c.renderbuffer),e.renderbufferStorage(36161,p,s,$),i.profile&&(c.stats.size=(n=c.format,o=c.width,u=c.height,en[n]*o*u)),l.format=f[c.format],l}return u[c.id]=c,n.renderbufferCount++,l(r,o),l.resize=function t(r,n){var a,f,o,u=0|r,s=0|n||u;return u===c.width&&s===c.height?l:(l.width=c.width=u,l.height=c.height=s,e.bindRenderbuffer(36161,c.renderbuffer),e.renderbufferStorage(36161,c.format,u,s),i.profile&&(c.stats.size=(a=c.format,f=c.width,o=c.height,en[a]*f*o)),l)},l._reglType="renderbuffer",l._renderbuffer=c,i.profile&&(l.stats=c.stats),l.destroy=function(){c.decRef()},l},clear:function(){v(u).forEach(c)},restore:function t(){v(u).forEach(function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,t.renderbuffer),e.renderbufferStorage(36161,t.format,t.width,t.height)}),e.bindRenderbuffer(36161,null)}}},ef=[];ef[6408]=4,ef[6407]=3;var eo=[];function eu(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.offset=0,this.stride=0,this.divisor=0}function es(e){return Array.prototype.slice.call(e)}function ec(e){return es(e).join("")}eo[5121]=1,eo[5126]=4,eo[36193]=2;var el="xyzw".split(""),e$="dither",ep="blend.enable",ed="blend.color",eh="blend.equation",em="blend.func",ev="depth.enable",ex="depth.func",eb="depth.range",eg="depth.mask",e_="colorMask",ey="cull.enable",ew="cull.face",e0="frontFace",e6="lineWidth",eA="polygonOffset.enable",e3="polygonOffset.offset",eD="sample.alpha",e2="sample.enable",e1="sample.coverage",e4="stencil.enable",eE="stencil.mask",ek="stencil.func",e8="stencil.opFront",eC="stencil.opBack",eT="scissor.enable",eS="scissor.box",eF="viewport",eO="profile",e5="framebuffer",eV="vert",e7="frag",eB="elements",ez="primitive",ej="count",eI="offset",eP="instances",eL="Width",eR="Height",eM=e5+eL,eH=e5+eR,eW=eF+eL,eQ=eF+eR,eN="drawingBuffer",eq=eN+eL,eU=eN+eR,eG=[em,eh,ek,e8,eC,e1,eF,eS,e3],eY={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},eX={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},eJ={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},eK={cw:2304,ccw:2305};function eZ(e){return Array.isArray(e)||h(e)||m(e)}function e9(e){return e.sort(function(e,t){return e===eF?-1:t===eF?1:e<t?-1:1})}function te(e,t,r,n){this.thisDep=e,this.contextDep=t,this.propDep=r,this.append=n}function tt(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function tr(e){return new te(!1,!1,!1,e)}function tn(e,t){var r=e.type;if(0===r){var n=e.data.length;return new te(!0,n>=1,n>=2,t)}if(4===r){var i=e.data;return new te(i.thisDep,i.contextDep,i.propDep,t)}if(5===r)return new te(!1,!1,!1,t);if(6!==r)return new te(3===r,2===r,1===r,t);for(var a=!1,f=!1,o=!1,u=0;u<e.data.length;++u){var s=e.data[u];if(1===s.type)o=!0;else if(2===s.type)f=!0;else if(3===s.type)a=!0;else if(0===s.type){a=!0;var c=s.data;c>=1&&(f=!0),c>=2&&(o=!0)}else 4===s.type&&(a=a||s.data.thisDep,f=f||s.data.contextDep,o=o||s.data.propDep)}return new te(a,f,o,t)}var ti=new te(!1,!1,!1,function(){}),ta=function(e,t){if(!t.ext_disjoint_timer_query)return null;var r=[];function n(e){r.push(e)}var i=[];function a(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var f=[];function o(e){f.push(e)}var u=[];function s(e,t,r){var n=f.pop()||new a;n.startQueryIndex=e,n.endQueryIndex=t,n.sum=0,n.stats=r,u.push(n)}var c=[],l=[];return{beginQuery:function e(n){var a=r.pop()||t.ext_disjoint_timer_query.createQueryEXT();t.ext_disjoint_timer_query.beginQueryEXT(35007,a),i.push(a),s(i.length-1,i.length,n)},endQuery:function e(){t.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:s,update:function e(){var r,a,f=i.length;if(0!==f){l.length=Math.max(l.length,f+1),c.length=Math.max(c.length,f+1),c[0]=0,l[0]=0;var s=0;for(a=0,r=0;a<i.length;++a){var $=i[a];t.ext_disjoint_timer_query.getQueryObjectEXT($,34919)?(s+=t.ext_disjoint_timer_query.getQueryObjectEXT($,34918),n($)):i[r++]=$,c[a+1]=s,l[a+1]=r}for(a=0,i.length=r,r=0;a<u.length;++a){var p=u[a],d=p.startQueryIndex,h=p.endQueryIndex;p.sum+=c[h]-c[d];var m=l[d],v=l[h];v===m?(p.stats.gpuTime+=p.sum/1e6,o(p)):(p.startQueryIndex=m,p.endQueryIndex=v,u[r++]=p)}u.length=r}},getNumPendingQueries:function(){return i.length},clear:function(){r.push.apply(r,i);for(var e=0;e<r.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(r[e]);i.length=0,r.length=0},restore:function(){i.length=0,r.length=0}}},tf="webglcontextlost",to="webglcontextrestored";function tu(e,t){for(var r=0;r<e.length;++r)if(e[r]===t)return r;return -1}return function t(r){var n=function t(r){var n,i,a,f,o,c,l=r||{},$={},p=[],d=[],h="undefined"==typeof window?1:window.devicePixelRatio,m=!1,v=function(e){},x=function(){};if("string"==typeof l?a=document.querySelector(l):"object"==typeof l&&("string"==typeof(n=l).nodeName&&"function"==typeof n.appendChild&&"function"==typeof n.getBoundingClientRect?a=l:"function"==typeof(i=l).drawArrays||"function"==typeof i.drawElements?o=(c=l).canvas:("gl"in l?c=l.gl:"canvas"in l?o=s(l.canvas):"container"in l&&(f=s(l.container)),"attributes"in l&&($=l.attributes),"extensions"in l&&(p=u(l.extensions)),"optionalExtensions"in l&&(d=u(l.optionalExtensions)),"onDone"in l&&(v=l.onDone),"profile"in l&&(m=!!l.profile),"pixelRatio"in l&&(h=+l.pixelRatio))),a&&("canvas"===a.nodeName.toLowerCase()?o=a:f=a),!c){if(!o){var b=function t(r,n,i){var a,f=document.createElement("canvas");function o(){var e=window.innerWidth,t=window.innerHeight;if(r!==document.body){var n=f.getBoundingClientRect();e=n.right-n.left,t=n.bottom-n.top}f.width=window.devicePixelRatio*e,f.height=window.devicePixelRatio*t}return e(f.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%",position:"absolute"}),r.appendChild(f),r===document.body&&(f.style.position="absolute",e(r.style,{margin:0,padding:0})),r!==document.body&&"function"==typeof ResizeObserver?(a=new ResizeObserver(function(){setTimeout(o)})).observe(r):window.addEventListener("resize",o,!1),o(),{canvas:f,onDestroy:function e(){a?a.disconnect():window.removeEventListener("resize",o),r.removeChild(f)}}}(f||document.body,v,h);if(!b)return null;o=b.canvas,x=b.onDestroy}void 0===$.premultipliedAlpha&&($.premultipliedAlpha=!0),c=function e(t,r){function n(e){try{return t.getContext(e,r)}catch(n){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}(o,$)}return c?{gl:c,canvas:o,container:f,extensions:p,optionalExtensions:d,pixelRatio:h,profile:m,onDone:v,onDestroy:x}:(x(),v("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}(r);if(!n)return null;var i=n.gl,l=i.getContextAttributes(),$=i.isContextLost(),b=function e(t,r){var n={};function i(e){var r,i=e.toLowerCase();try{r=n[i]=t.getExtension(i)}catch(a){}return!!r}for(var a=0;a<r.extensions.length;++a){var f=r.extensions[a];if(!i(f))return r.onDestroy(),r.onDone('"'+f+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return r.optionalExtensions.forEach(i),{extensions:n,restore:function(){Object.keys(n).forEach(function(e){if(n[e]&&!i(e))throw Error("(regl): error restoring extension "+e)})}}}(i,n);if(!b)return null;var g,S,F=(g={"":0},S=[""],{id:function(e){var t=g[e];return t||(t=g[e]=S.length,S.push(e)),t},str:function(e){return S[e]}}),I={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},P=b.extensions,L=ta(i,P),Q=o(),N=i.drawingBufferWidth,q=i.drawingBufferHeight,en={tick:0,time:0,viewportWidth:N,viewportHeight:q,framebufferWidth:N,framebufferHeight:q,drawingBufferWidth:N,drawingBufferHeight:q,pixelRatio:n.pixelRatio},ei={elements:null,primitive:4,count:-1,offset:0,instances:-1},eL=d(i,P),eR=function e(t,r,n,i){var a=0,f={};function o(e){this.id=a++,this.buffer=t.createBuffer(),this.type=e,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,n.profile&&(this.stats={size:0})}o.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},o.prototype.destroy=function(){l(this)};var u=[];function s(e,r,n){e.byteLength=r.byteLength,t.bufferData(e.type,r,n)}function c(e,t,r,n,i,a){if(e.usage=r,Array.isArray(t)){if(e.dtype=n||5126,t.length>0){if(Array.isArray(t[0])){f=A(t);for(var f,o,u=1,c=1;c<f.length;++c)u*=f[c];e.dimension=u,o=w(t,f,e.dtype),s(e,o,r),a?e.persistentData=o:p.freeType(o)}else if("number"==typeof t[0]){e.dimension=i;var l=p.allocType(e.dtype,t.length);k(l,t),s(e,l,r),a?e.persistentData=l:p.freeType(l)}else h(t[0])&&(e.dimension=t[0].length,e.dtype=n||E(t[0])||5126,o=w(t,[t.length,t[0].length],e.dtype),s(e,o,r),a?e.persistentData=o:p.freeType(o))}}else if(h(t))e.dtype=n||E(t),e.dimension=i,s(e,t,r),a&&(e.persistentData=new Uint8Array(new Uint8Array(t.buffer)));else if(m(t)){f=t.shape;var $=t.stride,d=t.offset,v=0,x=0,b=0,g=0;1===f.length?(v=f[0],x=1,b=$[0],g=0):2===f.length&&(v=f[0],x=f[1],b=$[0],g=$[1]),e.dtype=n||E(t.data)||5126,e.dimension=x;var _=p.allocType(e.dtype,v*x);C(_,t.data,v,x,b,g,d),s(e,_,r),a?e.persistentData=_:p.freeType(_)}else t instanceof ArrayBuffer&&(e.dtype=5121,e.dimension=i,s(e,t,r),a&&(e.persistentData=new Uint8Array(new Uint8Array(t))))}function l(e){r.bufferCount--,i(e);var n=e.buffer;t.deleteBuffer(n),e.buffer=null,delete f[e.id]}return n.profile&&(r.getTotalBufferSize=function(){var e=0;return Object.keys(f).forEach(function(t){e+=f[t].stats.size}),e}),{create:function e(i,a,u,s){r.bufferCount++;var $=new o(a);function d(e){var r=35044,i=null,a=0,f=0,o=1;return Array.isArray(e)||h(e)||m(e)||e instanceof ArrayBuffer?i=e:"number"==typeof e?a=0|e:e&&("data"in e&&(i=e.data),"usage"in e&&(r=y[e.usage]),"type"in e&&(f=_[e.type]),"dimension"in e&&(o=0|e.dimension),"length"in e&&(a=0|e.length)),$.bind(),i?c($,i,r,f,o,s):(a&&t.bufferData($.type,a,r),$.dtype=f||5121,$.usage=r,$.dimension=o,$.byteLength=a),n.profile&&($.stats.size=$.byteLength*D[$.dtype]),d}function v(e,r){t.bufferSubData($.type,r,e)}return f[$.id]=$,u||d(i),d._reglType="buffer",d._buffer=$,d.subdata=function e(t,r){var n,i=0|(r||0);if($.bind(),h(t)||t instanceof ArrayBuffer)v(t,i);else if(Array.isArray(t)){if(t.length>0){if("number"==typeof t[0]){var a=p.allocType($.dtype,t.length);k(a,t),v(a,i),p.freeType(a)}else if(Array.isArray(t[0])||h(t[0])){n=A(t);var f=w(t,n,$.dtype);v(f,i),p.freeType(f)}}}else if(m(t)){n=t.shape;var o=t.stride,u=0,s=0,c=0,l=0;1===n.length?(u=n[0],s=1,c=o[0],l=0):2===n.length&&(u=n[0],s=n[1],c=o[0],l=o[1]);var x=Array.isArray(t.data)?$.dtype:E(t.data),b=p.allocType(x,u*s);C(b,t.data,u,s,c,l,t.offset),v(b,i),p.freeType(b)}return d},n.profile&&(d.stats=$.stats),d.destroy=function(){l($)},d},createStream:function e(t,r){var n=u.pop();return n||(n=new o(t)),n.bind(),c(n,r,35040,0,1,!1),n},destroyStream:function e(t){u.push(t)},clear:function(){v(f).forEach(l),u.forEach(l)},getBuffer:function(e){return e&&e._buffer instanceof o?e._buffer:null},restore:function e(){v(f).forEach(function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)})},_initBuffer:c}}(i,I,n,function e(t){return ts.destroyBuffer(t)}),eN=function e(t,r,n,i){var a={},f=0,o={uint8:5121,uint16:5123};function u(e){this.id=f++,a[this.id]=this,this.buffer=e,this.primType=4,this.vertCount=0,this.type=0}r.oes_element_index_uint&&(o.uint32=5125),u.prototype.bind=function(){this.buffer.bind()};var s=[];function c(e,i,a,f,o,u,s){if(e.buffer.bind(),i){var c,l=s;!s&&(!h(i)||m(i)&&!h(i.data))&&(l=r.oes_element_index_uint?5125:5123),n._initBuffer(e.buffer,i,a,l,3)}else t.bufferData(34963,u,a),e.buffer.dtype=c||5121,e.buffer.usage=a,e.buffer.dimension=3,e.buffer.byteLength=u;if(c=s,!s){switch(e.buffer.dtype){case 5121:case 5120:c=5121;break;case 5123:case 5122:c=5123;break;case 5125:case 5124:c=5125}e.buffer.dtype=c}e.type=c;var $=o;$<0&&($=e.buffer.byteLength,5123===c?$>>=1:5125===c&&($>>=2)),e.vertCount=$;var p=f;if(f<0){p=4;var d=e.buffer.dimension;1===d&&(p=0),2===d&&(p=1),3===d&&(p=4)}e.primType=p}function l(e){i.elementsCount--,delete a[e.id],e.buffer.destroy(),e.buffer=null}return{create:function e(t,r){var a=n.create(null,34963,!0),f=new u(a._buffer);function s(e){if(e){if("number"==typeof e)a(e),f.primType=4,f.vertCount=0|e,f.type=5121;else{var t=null,r=35044,n=-1,i=-1,u=0,l=0;Array.isArray(e)||h(e)||m(e)?t=e:("data"in e&&(t=e.data),"usage"in e&&(r=y[e.usage]),"primitive"in e&&(n=T[e.primitive]),"count"in e&&(i=0|e.count),"type"in e&&(l=o[e.type]),"length"in e?u=0|e.length:(u=i,5123===l||5122===l?u*=2:(5125===l||5124===l)&&(u*=4))),c(f,t,r,n,i,u,l)}}else a(),f.primType=4,f.vertCount=0,f.type=5121;return s}return i.elementsCount++,s(t),s._reglType="elements",s._elements=f,s.subdata=function(e,t){return a.subdata(e,t),s},s.destroy=function(){l(f)},s},createStream:function e(t){var r=s.pop();return r||(r=new u(n.create(null,34963,!0,!1)._buffer)),c(r,t,35040,-1,-1,0,0),r},destroyStream:function e(t){s.push(t)},getElements:function(e){return"function"==typeof e&&e._elements instanceof u?e._elements:null},clear:function(){v(a).forEach(l)}}}(i,P,eR,I),ts=function e(t,r,n,i,a,f,o){for(var u=n.maxAttributes,s=Array(u),c=0;c<u;++c)s[c]=new eu;var l=0,$={},p={Record:eu,scope:{},state:s,currentVAO:null,targetVAO:null,restore:d()?function e(){d()&&v($).forEach(function(e){e.refresh()})}:function(){},createVAO:function e(t){var r=new b;function n(e){if(Array.isArray(e))s=e,r.elements&&r.ownsElements&&r.elements.destroy(),r.elements=null,r.ownsElements=!1,r.offset=0,r.count=0,r.instances=-1,r.primitive=4;else{if(e.elements){var t=e.elements;r.ownsElements?"function"==typeof t&&"elements"===t._reglType?(r.elements.destroy(),r.ownsElements=!1):(r.elements(t),r.ownsElements=!1):f.getElements(e.elements)?(r.elements=e.elements,r.ownsElements=!1):(r.elements=f.create(e.elements),r.ownsElements=!0)}else r.elements=null,r.ownsElements=!1;s=e.attributes,r.offset=0,r.count=-1,r.instances=-1,r.primitive=4,r.elements&&(r.count=r.elements._elements.vertCount,r.primitive=r.elements._elements.primType),"offset"in e&&(r.offset=0|e.offset),"count"in e&&(r.count=0|e.count),"instances"in e&&(r.instances=0|e.instances),"primitive"in e&&(r.primitive=T[e.primitive])}var i={},o=r.attributes;o.length=s.length;for(var u=0;u<s.length;++u){var s,c,l=s[u],$=o[u]=new eu,p=l.data||l;Array.isArray(p)||h(p)||m(p)?(r.buffers[u]&&(c=r.buffers[u],h(p)&&c._buffer.byteLength>=p.byteLength?c.subdata(p):(c.destroy(),r.buffers[u]=null)),r.buffers[u]||(c=r.buffers[u]=a.create(l,34962,!1,!0)),$.buffer=a.getBuffer(c),$.size=0|$.buffer.dimension,$.normalized=!1,$.type=$.buffer.dtype,$.offset=0,$.stride=0,$.divisor=0,$.state=1,i[u]=1):a.getBuffer(l)?($.buffer=a.getBuffer(l),$.size=0|$.buffer.dimension,$.normalized=!1,$.type=$.buffer.dtype,$.offset=0,$.stride=0,$.divisor=0,$.state=1):a.getBuffer(l.buffer)?($.buffer=a.getBuffer(l.buffer),$.size=0|(+l.size||$.buffer.dimension),$.normalized=!!l.normalized,"type"in l?$.type=_[l.type]:$.type=$.buffer.dtype,$.offset=0|(l.offset||0),$.stride=0|(l.stride||0),$.divisor=0|(l.divisor||0),$.state=1):"x"in l&&($.x=+l.x||0,$.y=+l.y||0,$.z=+l.z||0,$.w=+l.w||0,$.state=2)}for(var d=0;d<r.buffers.length;++d)!i[d]&&r.buffers[d]&&(r.buffers[d].destroy(),r.buffers[d]=null);return r.refresh(),n}return i.vaoCount+=1,n.destroy=function(){for(var e=0;e<r.buffers.length;++e)r.buffers[e]&&r.buffers[e].destroy();r.buffers.length=0,r.ownsElements&&(r.elements.destroy(),r.elements=null,r.ownsElements=!1),r.destroy()},n._vao=r,n._reglType="vao",n(t)},getVAO:function e(t){return"function"==typeof t&&t._vao?t._vao:null},destroyBuffer:function e(r){for(var n=0;n<s.length;++n){var i=s[n];i.buffer===r&&(t.disableVertexAttribArray(n),i.buffer=null)}},setVAO:d()?function e(t){if(t!==p.currentVAO){var r=d();t?r.bindVertexArrayOES(t.vao):r.bindVertexArrayOES(null),p.currentVAO=t}}:function e(r){if(r!==p.currentVAO){if(r)r.bindAttrs();else{for(var n=x(),i=0;i<s.length;++i){var a=s[i];a.buffer?(t.enableVertexAttribArray(i),a.buffer.bind(),t.vertexAttribPointer(i,a.size,a.type,a.normalized,a.stride,a.offfset),n&&a.divisor&&n.vertexAttribDivisorANGLE(i,a.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,a.x,a.y,a.z,a.w))}o.elements?t.bindBuffer(34963,o.elements.buffer.buffer):t.bindBuffer(34963,null)}p.currentVAO=r}},clear:d()?function e(){v($).forEach(function(e){e.destroy()})}:function(){}};function d(){return r.oes_vertex_array_object}function x(){return r.angle_instanced_arrays}function b(){this.id=++l,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var e=d();e?this.vao=e.createVertexArrayOES():this.vao=null,$[this.id]=this,this.buffers=[]}return b.prototype.bindAttrs=function(){for(var e=x(),r=this.attributes,n=0;n<r.length;++n){var i=r[n];i.buffer?(t.enableVertexAttribArray(n),t.bindBuffer(34962,i.buffer.buffer),t.vertexAttribPointer(n,i.size,i.type,i.normalized,i.stride,i.offset),e&&i.divisor&&e.vertexAttribDivisorANGLE(n,i.divisor)):(t.disableVertexAttribArray(n),t.vertexAttrib4f(n,i.x,i.y,i.z,i.w))}for(var a=r.length;a<u;++a)t.disableVertexAttribArray(a);var o=f.getElements(this.elements);o?t.bindBuffer(34963,o.buffer.buffer):t.bindBuffer(34963,null)},b.prototype.refresh=function(){var e=d();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),p.currentVAO=null,e.bindVertexArrayOES(null))},b.prototype.destroy=function(){if(this.vao){var e=d();this===p.currentVAO&&(p.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),$[this.id]&&(delete $[this.id],i.vaoCount-=1)},p}(i,P,eL,I,eR,eN,ei),tc=function t(r,n,i,a){var f={},o={};function u(e,t,r,n){this.name=e,this.id=t,this.location=r,this.info=n}function s(e,t){for(var r=0;r<e.length;++r)if(e[r].id===t.id){e[r].location=t.location;return}e.push(t)}function c(e,t,i){var a=35632===e?f:o,u=a[t];if(!u){var s=n.str(t);u=r.createShader(e),r.shaderSource(u,s),r.compileShader(u),a[t]=u}return u}var l={},$=[],p=0;function d(e,t){this.id=p++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,a.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function h(e,t,i){var f,o,l=c(35632,e.fragId),$=c(35633,e.vertId),p=e.program=r.createProgram();if(r.attachShader(p,l),r.attachShader(p,$),i)for(f=0;f<i.length;++f){var d=i[f];r.bindAttribLocation(p,d[0],d[1])}r.linkProgram(p);var h=r.getProgramParameter(p,35718);a.profile&&(e.stats.uniformsCount=h);var m=e.uniforms;for(f=0;f<h;++f)if(o=r.getActiveUniform(p,f)){if(o.size>1)for(var v=0;v<o.size;++v){var x=o.name.replace("[0]","["+v+"]");s(m,new u(x,n.id(x),r.getUniformLocation(p,x),o))}var b=o.name;o.size>1&&(b=b.replace("[0]","")),s(m,new u(b,n.id(b),r.getUniformLocation(p,b),o))}var g=r.getProgramParameter(p,35721);a.profile&&(e.stats.attributesCount=g);var _=e.attributes;for(f=0;f<g;++f)(o=r.getActiveAttrib(p,f))&&s(_,new u(o.name,n.id(o.name),r.getAttribLocation(p,o.name),o))}return a.profile&&(i.getMaxUniformsCount=function(){var e=0;return $.forEach(function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)}),e},i.getMaxAttributesCount=function(){var e=0;return $.forEach(function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)}),e}),{clear:function(){var e=r.deleteShader.bind(r);v(f).forEach(e),f={},v(o).forEach(e),o={},$.forEach(function(e){r.deleteProgram(e.program)}),$.length=0,l={},i.shaderCount=0},program:function(t,n,a,u){var s=l[n];s||(s=l[n]={});var c=s[t];if(c&&(c.refCount++,!u))return c;var p=new d(n,t);return i.shaderCount++,h(p,a,u),c||(s[t]=p),$.push(p),e(p,{destroy:function(){if(p.refCount--,p.refCount<=0){r.deleteProgram(p.program);var e=$.indexOf(p);$.splice(e,1),i.shaderCount--}s[p.vertId].refCount<=0&&(r.deleteShader(o[p.vertId]),delete o[p.vertId],delete l[p.fragId][p.vertId]),Object.keys(l[p.fragId]).length||(r.deleteShader(f[p.fragId]),delete f[p.fragId],delete l[p.fragId])}})},restore:function e(){f={},o={};for(var t=0;t<$.length;++t)h($[t],null,$[t].attributes.map(function(e){return[e.location,e.name]}))},shader:c,frag:-1,vert:-1}}(i,F,I,n),tl=function t(r,n,i,a,f,o,u){var s={"don't care":4352,"dont care":4352,nice:4354,fast:4353},c={repeat:10497,clamp:33071,mirror:33648},l={nearest:9728,linear:9729},$=e({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},l),d={none:0,browser:37444},b={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},g={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},_={};n.ext_srgb&&(g.srgb=35904,g.srgba=35906),n.oes_texture_float&&(b.float32=b.float=5126),n.oes_texture_half_float&&(b.float16=b["half float"]=36193),n.webgl_depth_texture&&(e(g,{depth:6402,"depth stencil":34041}),e(b,{uint16:5123,uint32:5125,"depth stencil":34042})),n.webgl_compressed_texture_s3tc&&e(_,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),n.webgl_compressed_texture_atc&&e(_,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),n.webgl_compressed_texture_pvrtc&&e(_,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),n.webgl_compressed_texture_etc1&&(_["rgb etc1"]=36196);var y=Array.prototype.slice.call(r.getParameter(34467));Object.keys(_).forEach(function(e){var t=_[e];y.indexOf(t)>=0&&(g[e]=t)});var w=Object.keys(g);i.textureFormats=w;var A=[];Object.keys(g).forEach(function(e){A[g[e]]=e});var D=[];Object.keys(b).forEach(function(e){D[b[e]]=e});var E=[];Object.keys(l).forEach(function(e){E[l[e]]=e});var k=[];Object.keys($).forEach(function(e){k[$[e]]=e});var C=[];Object.keys(c).forEach(function(e){C[c[e]]=e});var T=w.reduce(function(e,t){var r=g[t];return 6409===r||6406===r||6409===r||6410===r||6402===r||34041===r||n.ext_srgb&&(35904===r||35906===r)?e[r]=r:32855===r||t.indexOf("rgba")>=0?e[r]=6408:e[r]=6407,e},{});function S(){this.internalformat=6408,this.format=6408,this.type=5121,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=37444,this.width=0,this.height=0,this.channels=0}function F(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function I(e,t){if("object"==typeof t&&t){if("premultiplyAlpha"in t&&(e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(e.flipY=t.flipY),"alignment"in t&&(e.unpackAlignment=t.alignment),"colorSpace"in t&&(e.colorSpace=d[t.colorSpace]),"type"in t){var r=t.type;e.type=b[r]}var n=e.width,i=e.height,a=e.channels,f=!1;"shape"in t?(n=t.shape[0],i=t.shape[1],3===t.shape.length&&(a=t.shape[2],f=!0)):("radius"in t&&(n=i=t.radius),"width"in t&&(n=t.width),"height"in t&&(i=t.height),"channels"in t&&(a=t.channels,f=!0)),e.width=0|n,e.height=0|i,e.channels=0|a;var o=!1;if("format"in t){var u=t.format,s=e.internalformat=g[u];e.format=T[s],u in b&&!("type"in t)&&(e.type=b[u]),u in _&&(e.compressed=!0),o=!0}!f&&o?e.channels=j[e.format]:f&&!o&&e.channels!==z[e.format]&&(e.format=e.internalformat=z[e.channels])}}function P(e){r.pixelStorei(37440,e.flipY),r.pixelStorei(37441,e.premultiplyAlpha),r.pixelStorei(37443,e.colorSpace),r.pixelStorei(3317,e.unpackAlignment)}function L(){S.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function Q(e,t){var r=null;if(K(t)?r=t:t&&(I(e,t),"x"in t&&(e.xOffset=0|t.x),"y"in t&&(e.yOffset=0|t.y),K(t.data)&&(r=t.data)),t.copy){var n=f.viewportWidth,i=f.viewportHeight;e.width=e.width||n-e.xOffset,e.height=e.height||i-e.yOffset,e.needsCopy=!0}else if(r){if(h(r))e.channels=e.channels||4,e.data=r,"type"in t||5121!==e.type||(e.type=Z(r));else if(U(r))e.channels=e.channels||4,function e(t,r){var n=r.length;switch(t.type){case 5121:case 5123:case 5125:case 5126:var i=p.allocType(t.type,n);i.set(r),t.data=i;break;case 36193:t.data=O(r)}}(e,r),e.alignment=1,e.needsFree=!0;else if(m(r)){var a,o,u,s,c,l,$=r.data;Array.isArray($)||5121!==e.type||(e.type=Z($));var d=r.shape,v=r.stride;3===d.length?(u=d[2],l=v[2]):(u=1,l=1),a=d[0],o=d[1],s=v[0],c=v[1],e.alignment=1,e.width=a,e.height=o,e.channels=u,e.format=e.internalformat=z[u],e.needsFree=!0,function e(t,r,n,i,a,f){for(var o=t.width,u=t.height,s=t.channels,c=ee(t,o*u*s),l=0,$=0;$<u;++$)for(var p=0;p<o;++p)for(var d=0;d<s;++d)c[l++]=r[n*p+i*$+a*d+f];et(t,c)}(e,$,s,c,l,r.offset)}else if(X(r)||J(r)||Y(b=r)===R)X(r)||J(r)?e.element=r:e.element=r.canvas,e.width=e.element.width,e.height=e.element.height,e.channels=4;else if(Y(g=r)===M)e.element=r,e.width=r.width,e.height=r.height,e.channels=4;else if(Y(_=r)===H)e.element=r,e.width=r.naturalWidth,e.height=r.naturalHeight,e.channels=4;else if(Y(y=r)===W)e.element=r,e.width=r.videoWidth,e.height=r.videoHeight,e.channels=4;else if(G(r)){var b,g,_,y,w=e.width||r[0].length,A=e.height||r.length,D=e.channels;D=V(r[0][0])?D||r[0][0].length:D||1;for(var E=x.shape(r),k=1,C=0;C<E.length;++C)k*=E[C];var T=ee(e,k);x.flatten(r,E,"",T),et(e,T),e.alignment=1,e.width=w,e.height=A,e.channels=D,e.format=e.internalformat=z[D],e.needsFree=!0}}else e.width=e.width||1,e.height=e.height||1,e.channels=e.channels||4;5126===e.type||e.type}function N(e,t,n){var i=e.element,f=e.data,o=e.internalformat,u=e.format,s=e.type,c=e.width,l=e.height;P(e),i?r.texImage2D(t,n,u,u,s,i):e.compressed?r.compressedTexImage2D(t,n,o,c,l,0,f):e.needsCopy?(a(),r.copyTexImage2D(t,n,u,e.xOffset,e.yOffset,c,l,0)):r.texImage2D(t,n,u,c,l,0,u,s,f||null)}function q(e,t,n,i,f){var o=e.element,u=e.data,s=e.internalformat,c=e.format,l=e.type,$=e.width,p=e.height;P(e),o?r.texSubImage2D(t,f,n,i,c,l,o):e.compressed?r.compressedTexSubImage2D(t,f,n,i,s,$,p,u):e.needsCopy?(a(),r.copyTexSubImage2D(t,f,n,i,e.xOffset,e.yOffset,$,p)):r.texSubImage2D(t,f,n,i,$,p,c,l,u)}var en=[];function ei(){return en.pop()||new L}function ea(e){e.needsFree&&p.freeType(e.data),L.call(e),en.push(e)}function ef(){S.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function eo(e,t,r){var n=e.images[0]=ei();e.mipmask=1,n.width=e.width=t,n.height=e.height=r,n.channels=e.channels=4}function eu(e,t){var r=null;if(K(t))F(r=e.images[0]=ei(),e),Q(r,t),e.mipmask=1;else if(I(e,t),Array.isArray(t.mipmap))for(var n=t.mipmap,i=0;i<n.length;++i)F(r=e.images[i]=ei(),e),r.width>>=i,r.height>>=i,Q(r,n[i]),e.mipmask|=1<<i;else F(r=e.images[0]=ei(),e),Q(r,t),e.mipmask=1;F(e,e.images[0]),e.compressed&&(33776===e.internalformat||33777===e.internalformat||33778===e.internalformat||e.internalformat)}function es(e,t){for(var r=e.images,n=0;n<r.length;++n){if(!r[n])return;N(r[n],t,n)}}var ec=[];function el(){var e=ec.pop()||new ef;S.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function e$(e){for(var t=e.images,r=0;r<t.length;++r)t[r]&&ea(t[r]),t[r]=null;ec.push(e)}function ep(){this.minFilter=9728,this.magFilter=9728,this.wrapS=33071,this.wrapT=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function ed(e,t){if("min"in t){var r=t.min;e.minFilter=$[r],!(B.indexOf(e.minFilter)>=0)||"faces"in t||(e.genMipmaps=!0)}if("mag"in t){var n=t.mag;e.magFilter=l[n]}var i=e.wrapS,a=e.wrapT;if("wrap"in t){var f=t.wrap;"string"==typeof f?i=a=c[f]:Array.isArray(f)&&(i=c[f[0]],a=c[f[1]])}else"wrapS"in t&&(i=c[t.wrapS]),"wrapT"in t&&(a=c[t.wrapT]);if(e.wrapS=i,e.wrapT=a,"anisotropic"in t&&(t.anisotropic,e.anisotropic=t.anisotropic),"mipmap"in t){var o=!1;switch(typeof t.mipmap){case"string":e.mipmapHint=s[t.mipmap],e.genMipmaps=!0,o=!0;break;case"boolean":o=e.genMipmaps=t.mipmap;break;case"object":e.genMipmaps=!1,o=!0}!o||"min"in t||(e.minFilter=9984)}}function eh(e,t){r.texParameteri(t,10241,e.minFilter),r.texParameteri(t,10240,e.magFilter),r.texParameteri(t,10242,e.wrapS),r.texParameteri(t,10243,e.wrapT),n.ext_texture_filter_anisotropic&&r.texParameteri(t,34046,e.anisotropic),e.genMipmaps&&(r.hint(33170,e.mipmapHint),r.generateMipmap(t))}var em=0,ev={},ex=i.maxTextureUnits,eb=Array(ex).map(function(){return null});function eg(e){S.call(this),this.mipmask=0,this.internalformat=6408,this.id=em++,this.refCount=1,this.target=e,this.texture=r.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new ep,u.profile&&(this.stats={size:0})}function e_(e){r.activeTexture(33984),r.bindTexture(e.target,e.texture)}function ey(){var e=eb[0];e?r.bindTexture(e.target,e.texture):r.bindTexture(3553,null)}function ew(e){var t=e.texture,n=e.unit,i=e.target;n>=0&&(r.activeTexture(33984+n),r.bindTexture(i,null),eb[n]=null),r.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete ev[e.id],o.textureCount--}return e(eg.prototype,{bind:function(){var e=this;e.bindCount+=1;var t=e.unit;if(t<0){for(var n=0;n<ex;++n){var i=eb[n];if(i){if(i.bindCount>0)continue;i.unit=-1}eb[n]=e,t=n;break}u.profile&&o.maxTextureUnits<t+1&&(o.maxTextureUnits=t+1),e.unit=t,r.activeTexture(33984+t),r.bindTexture(e.target,e.texture)}return t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&ew(this)}}),u.profile&&(o.getTotalTextureSize=function(){var e=0;return Object.keys(ev).forEach(function(t){e+=ev[t].stats.size}),e}),{create2D:function e(t,n){var i=new eg(3553);function a(e,t){var r=i.texInfo;ep.call(r);var n=el();return"number"==typeof e?"number"==typeof t?eo(n,0|e,0|t):eo(n,0|e,0|e):e?(ed(r,e),eu(n,e)):eo(n,1,1),r.genMipmaps&&(n.mipmask=(n.width<<1)-1),i.mipmask=n.mipmask,F(i,n),i.internalformat=n.internalformat,a.width=n.width,a.height=n.height,e_(i),es(n,3553),eh(r,3553),ey(),e$(n),u.profile&&(i.stats.size=er(i.internalformat,i.type,n.width,n.height,r.genMipmaps,!1)),a.format=A[i.internalformat],a.type=D[i.type],a.mag=E[r.magFilter],a.min=k[r.minFilter],a.wrapS=C[r.wrapS],a.wrapT=C[r.wrapT],a}return ev[i.id]=i,o.textureCount++,a(t,n),a.subimage=function e(t,r,n,f){var o=0|r,u=0|n,s=0|f,c=ei();return F(c,i),c.width=0,c.height=0,Q(c,t),c.width=c.width||(i.width>>s)-o,c.height=c.height||(i.height>>s)-u,e_(i),q(c,3553,o,u,s),ey(),ea(c),a},a.resize=function e(t,n){var f=0|t,o=0|n||f;if(f===i.width&&o===i.height)return a;a.width=i.width=f,a.height=i.height=o,e_(i);for(var s=0;i.mipmask>>s;++s){var c=f>>s,l=o>>s;if(!c||!l)break;r.texImage2D(3553,s,i.format,c,l,0,i.format,i.type,null)}return ey(),u.profile&&(i.stats.size=er(i.internalformat,i.type,f,o,!1,!1)),a},a._reglType="texture2d",a._texture=i,u.profile&&(a.stats=i.stats),a.destroy=function(){i.decRef()},a},createCube:function e(t,n,i,a,f,s){var c=new eg(34067);ev[c.id]=c,o.cubeCount++;var l=Array(6);function $(e,t,r,n,i,a){var f,o=c.texInfo;for(ep.call(o),f=0;f<6;++f)l[f]=el();if("number"!=typeof e&&e){if("object"==typeof e){if(t)eu(l[0],e),eu(l[1],t),eu(l[2],r),eu(l[3],n),eu(l[4],i),eu(l[5],a);else if(ed(o,e),I(c,e),"faces"in e){var s=e.faces;for(f=0;f<6;++f)F(l[f],c),eu(l[f],s[f])}else for(f=0;f<6;++f)eu(l[f],e)}}else{var p=0|e||1;for(f=0;f<6;++f)eo(l[f],p,p)}for(F(c,l[0]),o.genMipmaps?c.mipmask=(l[0].width<<1)-1:c.mipmask=l[0].mipmask,c.internalformat=l[0].internalformat,$.width=l[0].width,$.height=l[0].height,e_(c),f=0;f<6;++f)es(l[f],34069+f);for(eh(o,34067),ey(),u.profile&&(c.stats.size=er(c.internalformat,c.type,$.width,$.height,o.genMipmaps,!0)),$.format=A[c.internalformat],$.type=D[c.type],$.mag=E[o.magFilter],$.min=k[o.minFilter],$.wrapS=C[o.wrapS],$.wrapT=C[o.wrapT],f=0;f<6;++f)e$(l[f]);return $}return $(t,n,i,a,f,s),$.subimage=function e(t,r,n,i,a){var f=0|n,o=0|i,u=0|a,s=ei();return F(s,c),s.width=0,s.height=0,Q(s,r),s.width=s.width||(c.width>>u)-f,s.height=s.height||(c.height>>u)-o,e_(c),q(s,34069+t,f,o,u),ey(),ea(s),$},$.resize=function e(t){var n=0|t;if(n!==c.width){$.width=c.width=n,$.height=c.height=n,e_(c);for(var i=0;i<6;++i)for(var a=0;c.mipmask>>a;++a)r.texImage2D(34069+i,a,c.format,n>>a,n>>a,0,c.format,c.type,null);return ey(),u.profile&&(c.stats.size=er(c.internalformat,c.type,$.width,$.height,!1,!0)),$}},$._reglType="textureCube",$._texture=c,u.profile&&($.stats=c.stats),$.destroy=function(){c.decRef()},$},clear:function e(){for(var t=0;t<ex;++t)r.activeTexture(33984+t),r.bindTexture(3553,null),eb[t]=null;v(ev).forEach(ew),o.cubeCount=0,o.textureCount=0},getTexture:function(e){return null},restore:function e(){for(var t=0;t<ex;++t){var n=eb[t];n&&(n.bindCount=0,n.unit=-1,eb[t]=null)}v(ev).forEach(function(e){e.texture=r.createTexture(),r.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if((e.mipmask&1<<t)!=0){if(3553===e.target)r.texImage2D(3553,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var n=0;n<6;++n)r.texImage2D(34069+n,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null)}eh(e.texInfo,e.target)})},refresh:function e(){for(var t=0;t<ex;++t){var n=eb[t];n&&(n.bindCount=0,n.unit=-1,eb[t]=null),r.activeTexture(33984+t),r.bindTexture(3553,null),r.bindTexture(34067,null)}}}}(i,P,eL,function(){td.procs.poll()},en,I,n),t$=ea(i,P,eL,I,n),tp=function t(r,n,i,a,f,o){var u={cur:null,next:null,dirty:!1,setFBO:null},s=["rgba"],c=["rgba4","rgb565","rgb5 a1"];n.ext_srgb&&c.push("srgba"),n.ext_color_buffer_half_float&&c.push("rgba16f","rgb16f"),n.webgl_color_buffer_float&&c.push("rgba32f");var l=["uint8"];function $(e,t,r){this.target=e,this.texture=t,this.renderbuffer=r;var n=0,i=0;t?(n=t.width,i=t.height):r&&(n=r.width,i=r.height),this.width=n,this.height=i}function p(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function d(e,t,r){if(e){if(e.texture){var n=e.texture._texture;n.width,n.height,n.refCount+=1}else{var i=e.renderbuffer._renderbuffer;i.refCount+=1}}}function h(e,t){t&&(t.texture?r.framebufferTexture2D(36160,e,t.target,t.texture._texture.texture,0):r.framebufferRenderbuffer(36160,e,36161,t.renderbuffer._renderbuffer.renderbuffer))}function m(e){var t=3553,r=null,n=null,i=e;"object"==typeof e&&(i=e.data,"target"in e&&(t=0|e.target));var a=i._reglType;return"texture2d"===a?r=i:"textureCube"===a?r=i:"renderbuffer"===a&&(n=i,t=36161),new $(t,r,n)}function x(e,t,r,n,i){if(r){var o=a.create2D({width:e,height:t,format:n,type:i});return o._texture.refCount=0,new $(3553,o,null)}var u=f.create({width:e,height:t,format:n});return u._renderbuffer.refCount=0,new $(36161,null,u)}function b(e){return e&&(e.texture||e.renderbuffer)}function g(e,t,r){e&&(e.texture?e.texture.resize(t,r):e.renderbuffer&&e.renderbuffer.resize(t,r),e.width=t,e.height=r)}n.oes_texture_half_float&&l.push("half float","float16"),n.oes_texture_float&&l.push("float","float32");var _=0,y={};function w(){this.id=_++,y[this.id]=this,this.framebuffer=r.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function A(e){e.colorAttachments.forEach(p),p(e.depthAttachment),p(e.stencilAttachment),p(e.depthStencilAttachment)}function D(e){var t=e.framebuffer;r.deleteFramebuffer(t),e.framebuffer=null,o.framebufferCount--,delete y[e.id]}function E(e){r.bindFramebuffer(36160,e.framebuffer);var t,n=e.colorAttachments;for(t=0;t<n.length;++t)h(36064+t,n[t]);for(t=n.length;t<i.maxColorAttachments;++t)r.framebufferTexture2D(36160,36064+t,3553,null,0);r.framebufferTexture2D(36160,33306,3553,null,0),r.framebufferTexture2D(36160,36096,3553,null,0),r.framebufferTexture2D(36160,36128,3553,null,0),h(36096,e.depthAttachment),h(36128,e.stencilAttachment),h(33306,e.depthStencilAttachment),r.checkFramebufferStatus(36160),r.isContextLost(),r.bindFramebuffer(36160,u.next?u.next.framebuffer:null),u.cur=u.next,r.getError()}function k(t,r){var n=new w;function i(e,t){var r,a=0,f=0,o=!0,u=!0,l=null,$=!0,p="rgba",h="uint8",v=1,g=null,_=null,y=null,w=!1;if("number"==typeof e)a=0|e,f=0|t||a;else if(e){var D=e;if("shape"in D){var k=D.shape;a=k[0],f=k[1]}else"radius"in D&&(a=f=D.radius),"width"in D&&(a=D.width),"height"in D&&(f=D.height);("color"in D||"colors"in D)&&Array.isArray(l=D.color||D.colors),!l&&("colorCount"in D&&(v=0|D.colorCount),"colorTexture"in D&&($=!!D.colorTexture,p="rgba4"),"colorType"in D&&(h=D.colorType,$||("half float"===h||"float16"===h?p="rgba16f":"float"!==h&&"float32"!==h||(p="rgba32f"))),"colorFormat"in D&&(p=D.colorFormat,s.indexOf(p)>=0?$=!0:c.indexOf(p)>=0&&($=!1))),("depthTexture"in D||"depthStencilTexture"in D)&&(w=!!(D.depthTexture||D.depthStencilTexture)),"depth"in D&&("boolean"==typeof D.depth?o=D.depth:(g=D.depth,u=!1)),"stencil"in D&&("boolean"==typeof D.stencil?u=D.stencil:(_=D.stencil,o=!1)),"depthStencil"in D&&("boolean"==typeof D.depthStencil?o=u=D.depthStencil:(y=D.depthStencil,o=!1,u=!1))}else a=f=1;var C=null,T=null,S=null,F=null;if(Array.isArray(l))C=l.map(m);else if(l)C=[m(l)];else for(r=0,C=Array(v);r<v;++r)C[r]=x(a,f,$,p,h);a=a||C[0].width,f=f||C[0].height,g?T=m(g):o&&!u&&(T=x(a,f,w,"depth","uint32")),_?S=m(_):u&&!o&&(S=x(a,f,!1,"stencil","uint8")),y?F=m(y):!g&&!_&&u&&o&&(F=x(a,f,w,"depth stencil","depth stencil"));var O=null;for(r=0;r<C.length;++r)if(d(C[r],a,f),C[r]&&C[r].texture){var V=ef[C[r].texture._texture.format]*eo[C[r].texture._texture.type];null===O&&(O=V)}return d(T,a,f),d(S,a,f),d(F,a,f),A(n),n.width=a,n.height=f,n.colorAttachments=C,n.depthAttachment=T,n.stencilAttachment=S,n.depthStencilAttachment=F,i.color=C.map(b),i.depth=b(T),i.stencil=b(S),i.depthStencil=b(F),i.width=n.width,i.height=n.height,E(n),i}return o.framebufferCount++,i(t,r),e(i,{resize:function e(t,r){var a=Math.max(0|t,1),f=Math.max(0|r||a,1);if(a===n.width&&f===n.height)return i;for(var o=n.colorAttachments,u=0;u<o.length;++u)g(o[u],a,f);return g(n.depthAttachment,a,f),g(n.stencilAttachment,a,f),g(n.depthStencilAttachment,a,f),n.width=i.width=a,n.height=i.height=f,E(n),i},_reglType:"framebuffer",_framebuffer:n,destroy:function(){D(n),A(n)},use:function(e){u.setFBO({framebuffer:i},e)}})}return e(u,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof w)return t}return null},create:k,createCube:function t(r){var n=Array(6);function i(t){var r,f,o={color:null},u=0,s=null,c="rgba",l="uint8",$=1;if("number"==typeof t)u=0|t;else if(t){var p=t;"shape"in p?u=p.shape[0]:("radius"in p&&(u=0|p.radius),"width"in p?(u=0|p.width,p):"height"in p&&(u=0|p.height)),("color"in p||"colors"in p)&&Array.isArray(s=p.color||p.colors),!s&&("colorCount"in p&&($=0|p.colorCount),"colorType"in p&&(l=p.colorType),"colorFormat"in p&&(c=p.colorFormat)),"depth"in p&&(o.depth=p.depth),"stencil"in p&&(o.stencil=p.stencil),"depthStencil"in p&&(o.depthStencil=p.depthStencil)}else u=1;if(s){if(Array.isArray(s))for(r=0,f=[];r<s.length;++r)f[r]=s[r];else f=[s]}else{f=Array($);var d={radius:u,format:c,type:l};for(r=0;r<$;++r)f[r]=a.createCube(d)}for(r=0,o.color=Array(f.length);r<f.length;++r){var h=f[r];u=u||h.width,o.color[r]={target:34069,data:f[r]}}for(r=0;r<6;++r){for(var m=0;m<f.length;++m)o.color[m].target=34069+r;r>0&&(o.depth=n[0].depth,o.stencil=n[0].stencil,o.depthStencil=n[0].depthStencil),n[r]?n[r](o):n[r]=k(o)}return e(i,{width:u,height:u,color:f})}return i(r),e(i,{faces:n,resize:function e(t){var r,a=0|t;if(a===i.width)return i;var f=i.color;for(r=0;r<f.length;++r)f[r].resize(a);for(r=0;r<6;++r)n[r].resize(a);return i.width=i.height=a,i},_reglType:"framebufferCube",destroy:function(){n.forEach(function(e){e.destroy()})}})},clear:function(){v(y).forEach(D)},restore:function e(){u.cur=null,u.next=null,u.dirty=!0,v(y).forEach(function(e){e.framebuffer=r.createFramebuffer(),E(e)})}})}(i,P,eL,tl,t$,I),td=function t(r,n,i,f,o,u,s,l,$,p,d,h,m,v,x){var b=p.Record,g={add:32774,subtract:32778,"reverse subtract":32779};i.ext_blend_minmax&&(g.min=32775,g.max=32776);var y=i.angle_instanced_arrays,w=i.webgl_draw_buffers,A=i.oes_vertex_array_object,D={dirty:!0,profile:x.profile},E={},k=[],C={},S={};function F(e){return e.replace(".","_")}function O(e,t,r){var n=F(e);k.push(e),E[n]=D[n]=!!r,C[n]=t}function B(e,t,r){var n=F(e);k.push(e),Array.isArray(r)?(D[n]=r.slice(),E[n]=r.slice()):D[n]=E[n]=r,S[n]=t}O(e$,3024),O(ep,3042),B(ed,"blendColor",[0,0,0,0]),B(eh,"blendEquationSeparate",[32774,32774]),B(em,"blendFuncSeparate",[1,0,1,0]),O(ev,2929,!0),B(ex,"depthFunc",513),B(eb,"depthRange",[0,1]),B(eg,"depthMask",!0),B(e_,e_,[!0,!0,!0,!0]),O(ey,2884),B(ew,"cullFace",1029),B(e0,e0,2305),B(e6,e6,1),O(eA,32823),B(e3,"polygonOffset",[0,0]),O(eD,32926),O(e2,32928),B(e1,"sampleCoverage",[1,!1]),O(e4,2960),B(eE,"stencilMask",-1),B(ek,"stencilFunc",[519,0,-1]),B(e8,"stencilOpSeparate",[1028,7680,7680,7680]),B(eC,"stencilOpSeparate",[1029,7680,7680,7680]),O(eT,3089),B(eS,"scissor",[0,0,r.drawingBufferWidth,r.drawingBufferHeight]),B(eF,eF,[0,0,r.drawingBufferWidth,r.drawingBufferHeight]);var z={gl:r,context:m,strings:n,next:E,current:D,draw:h,elements:u,buffer:o,shader:d,attributes:p.state,vao:p,uniforms:$,framebuffer:l,extensions:i,timer:v,isBufferArgs:eZ},j={primTypes:T,compareFuncs:eX,blendFuncs:eY,blendEquations:g,stencilOps:eJ,glTypes:_,orientationType:eK};w&&(j.backBuffer=[1029],j.drawBuffer=c(f.maxDrawbuffers,function(e){return 0===e?[0]:c(e,function(e){return 36064+e})}));var I=0;function P(){var t=function t(){var r=0,n=[],i=[];function a(){var t=[],n=[];return e(function e(){t.push.apply(t,es(arguments))},{def:function e(){var i="v"+r++;return n.push(i),arguments.length>0&&(t.push(i,"="),t.push.apply(t,es(arguments)),t.push(";")),i},toString:function(){return ec([n.length>0?"var "+n.join(",")+";":"",ec(t)])}})}function f(){var t=a(),r=a(),n=t.toString,i=r.toString;function f(e,n){r(e,n,"=",t.def(e,n),";")}return e(function(){t.apply(t,es(arguments))},{def:t.def,entry:t,exit:r,save:f,set:function(e,r,n){f(e,r),t(e,r,"=",n,";")},toString:function(){return n()+i()}})}var o=a(),u={};return{global:o,link:function e(t){for(var a=0;a<i.length;++a)if(i[a]===t)return n[a];var f="g"+r++;return n.push(f),i.push(t),f},block:a,proc:function t(r,n){var i=[];function a(){var e="a"+i.length;return i.push(e),e}n=n||0;for(var o=0;o<n;++o)a();var s=f(),c=s.toString;return u[r]=e(s,{arg:a,toString:function(){return ec(["function(",i.join(),"){",c(),"}"])}})},scope:f,cond:function t(){var r=ec(arguments),n=f(),i=f(),a=n.toString,o=i.toString;return e(n,{then:function(){return n.apply(n,es(arguments)),this},else:function(){return i.apply(i,es(arguments)),this},toString:function(){var e=o();return e&&(e="else{"+e+"}"),ec(["if(",r,"){",a(),"}",e])}})},compile:function e(){var t=['"use strict";',o,"return {"];Object.keys(u).forEach(function(e){t.push('"',e,'":',u[e].toString(),",")}),t.push("}");var r=ec(t).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,n.concat(r)).apply(null,i)}}}(),r=t.link,i=t.global;t.id=I++,t.batchId="0";var a=r(z),f=t.shared={props:"a0"};Object.keys(z).forEach(function(e){f[e]=i.def(a,".",e)});var o=t.next={},u=t.current={};Object.keys(S).forEach(function(e){Array.isArray(D[e])&&(o[e]=i.def(f.next,".",e),u[e]=i.def(f.current,".",e))});var s=t.constants={};Object.keys(j).forEach(function(e){s[e]=i.def(JSON.stringify(j[e]))}),t.invoke=function(e,n){switch(n.type){case 0:var i=["this",f.context,f.props,t.batchId];return e.def(r(n.data),".call(",i.slice(0,Math.max(n.data.length+1,4)),")");case 1:return e.def(f.props,n.data);case 2:return e.def(f.context,n.data);case 3:return e.def("this",n.data);case 4:return n.data.append(t,e),n.data.ref;case 5:return n.data.toString();case 6:return n.data.map(function(r){return t.invoke(e,r)})}},t.attribCache={};var c={};return t.scopeAttrib=function(e){var t=n.id(e);if(t in c)return c[t];var i=p.scope[t];return i||(i=p.scope[t]=new b),c[t]=r(i)},t}function L(e,t,r){var n=e.shared.context,i=e.scope();Object.keys(r).forEach(function(a){t.save(n,"."+a);var f=r[a].append(e,t);Array.isArray(f)?i(n,".",a,"=[",f.join(),"];"):i(n,".",a,"=",f,";")}),t(i)}function R(e,t,r,n){var i,a,f=e.shared,o=f.gl,u=f.framebuffer;w&&(i=t.def(f.extensions,".webgl_draw_buffers"));var s=e.constants,c=s.drawBuffer,l=s.backBuffer;a=r?r.append(e,t):t.def(u,".next"),n||t("if(",a,"!==",u,".cur){"),t("if(",a,"){",o,".bindFramebuffer(",36160,",",a,".framebuffer);"),w&&t(i,".drawBuffersWEBGL(",c,"[",a,".colorAttachments.length]);"),t("}else{",o,".bindFramebuffer(",36160,",null);"),w&&t(i,".drawBuffersWEBGL(",l,");"),t("}",u,".cur=",a,";"),n||t("}")}function M(e,t,r){var n=e.shared,i=n.gl,a=e.current,f=e.next,o=n.current,u=n.next,s=e.cond(o,".dirty");k.forEach(function(t){var n,l,$=F(t);if(!($ in r.state)){if($ in f){n=f[$],l=a[$];var p=c(D[$].length,function(e){return s.def(n,"[",e,"]")});s(e.cond(p.map(function(e,t){return e+"!=="+l+"["+t+"]"}).join("||")).then(i,".",S[$],"(",p,");",p.map(function(e,t){return l+"["+t+"]="+e}).join(";"),";"))}else{n=s.def(u,".",$);var d=e.cond(n,"!==",o,".",$);s(d),$ in C?d(e.cond(n).then(i,".enable(",C[$],");").else(i,".disable(",C[$],");"),o,".",$,"=",n,";"):d(i,".",S[$],"(",n,");",o,".",$,"=",n,";")}}}),0===Object.keys(r.state).length&&s(o,".dirty=false;"),t(s)}function H(e,t,r,n){var i=e.shared,a=e.current,f=i.current,o=i.gl;e9(Object.keys(r)).forEach(function(i){var u=r[i];if(!n||n(u)){var s=u.append(e,t);if(C[i]){var c=C[i];tt(u)?s?t(o,".enable(",c,");"):t(o,".disable(",c,");"):t(e.cond(s).then(o,".enable(",c,");").else(o,".disable(",c,");")),t(f,".",i,"=",s,";")}else if(V(s)){var l=a[i];t(o,".",S[i],"(",s,");",s.map(function(e,t){return l+"["+t+"]="+e}).join(";"),";")}else t(o,".",S[i],"(",s,");",f,".",i,"=",s,";")}})}function W(e,t){y&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function Q(e,t,r,n,i){var a,f,o,u=e.shared,s=e.stats,c=u.current,l=u.timer,$=r.profile;function p(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function d(e){e(a=t.def(),"=",p(),";"),"string"==typeof i?e(s,".count+=",i,";"):e(s,".count++;"),v&&(n?e(f=t.def(),"=",l,".getNumPendingQueries();"):e(l,".beginQuery(",s,");"))}function h(e){e(s,".cpuTime+=",p(),"-",a,";"),v&&(n?e(l,".pushScopeStats(",f,",",l,".getNumPendingQueries(),",s,");"):e(l,".endQuery();"))}function m(e){var r=t.def(c,".profile");t(c,".profile=",e,";"),t.exit(c,".profile=",r,";")}if($){if(tt($)){$.enable?(d(t),h(t.exit),m("true")):m("false");return}m(o=$.append(e,t))}else o=t.def(c,".profile");var x=e.block();d(x),t("if(",o,"){",x,"}");var b=e.block();h(b),t.exit("if(",o,"){",b,"}")}function N(e,t,r,n,i){var a=e.shared;n.forEach(function(n){var f,o=n.name,u=r.attributes[o];if(u){if(!i(u))return;f=u.append(e,t)}else{if(!i(ti))return;var s=e.scopeAttrib(o);f={},Object.keys(new b).forEach(function(e){f[e]=t.def(s,".",e)})}!function r(n,i,f){var o=a.gl,u=t.def(n,".location"),s=t.def(a.attributes,"[",u,"]"),c=f.state,l=f.buffer,$=[f.x,f.y,f.z,f.w],p=["buffer","normalized","offset","stride"];function d(){t("if(!",s,".buffer){",o,".enableVertexAttribArray(",u,");}");var r,n=f.type;if(r=f.size?t.def(f.size,"||",i):i,t("if(",s,".type!==",n,"||",s,".size!==",r,"||",p.map(function(e){return s+"."+e+"!=="+f[e]}).join("||"),"){",o,".bindBuffer(",34962,",",l,".buffer);",o,".vertexAttribPointer(",[u,r,n,f.normalized,f.stride,f.offset],");",s,".type=",n,";",s,".size=",r,";",p.map(function(e){return s+"."+e+"="+f[e]+";"}).join(""),"}"),y){var a=f.divisor;t("if(",s,".divisor!==",a,"){",e.instancing,".vertexAttribDivisorANGLE(",[u,a],");",s,".divisor=",a,";}")}}function h(){t("if(",s,".buffer){",o,".disableVertexAttribArray(",u,");",s,".buffer=null;","}if(",el.map(function(e,t){return s+"."+e+"!=="+$[t]}).join("||"),"){",o,".vertexAttrib4f(",u,",",$,");",el.map(function(e,t){return s+"."+e+"="+$[t]+";"}).join(""),"}")}1===c?d():2===c?h():(t("if(",c,"===",1,"){"),d(),t("}else{"),h(),t("}"))}(e.link(n),function e(t){switch(t){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}(n.info.type),f)})}function q(e,t,r,i,a,f){for(var o=e.shared,u=o.gl,s={},l=0;l<i.length;++l){var $,p,d=i[l],h=d.name,m=d.info.type,v=d.info.size,x=r.uniforms[h];if(v>1){if(!x)continue;var b=h.replace("[0]","");if(s[b])continue;s[b]=1}var g=e.link(d)+".location";if(x){if(!a(x))continue;if(tt(x)){var _=x.value;if(35678===m||35680===m){var y=e.link(_._texture||_.color[0]._texture);t(u,".uniform1i(",g,",",y+".bind());"),t.exit(y,".unbind();")}else if(35674===m||35675===m||35676===m){var w=e.global.def("new Float32Array(["+Array.prototype.slice.call(_)+"])"),A=2;35675===m?A=3:35676===m&&(A=4),t(u,".uniformMatrix",A,"fv(",g,",false,",w,");")}else{switch(m){case 5126:$="1f";break;case 35664:$="2f";break;case 35665:$="3f";break;case 35666:$="4f";break;case 35670:case 5124:$="1i";break;case 35671:case 35667:$="2i";break;case 35672:case 35668:$="3i";break;case 35673:case 35669:$="4i"}v>1?($+="v",_=e.global.def("["+Array.prototype.slice.call(_)+"]")):_=V(_)?Array.prototype.slice.call(_):_,t(u,".uniform",$,"(",g,",",_,");")}continue}p=x.append(e,t)}else{if(!a(ti))continue;p=t.def(o.uniforms,"[",n.id(h),"]")}35678===m?t("if(",p,"&&",p,'._reglType==="framebuffer"){',p,"=",p,".color[0];","}"):35680===m&&t("if(",p,"&&",p,'._reglType==="framebufferCube"){',p,"=",p,".color[0];","}");var D=1;switch(m){case 35678:case 35680:var E=t.def(p,"._texture");t(u,".uniform1i(",g,",",E,".bind());"),t.exit(E,".unbind();");continue;case 5124:case 35670:$="1i";break;case 35667:case 35671:$="2i",D=2;break;case 35668:case 35672:$="3i",D=3;break;case 35669:case 35673:$="4i",D=4;break;case 5126:$="1f";break;case 35664:$="2f",D=2;break;case 35665:$="3f",D=3;break;case 35666:$="4f",D=4;break;case 35674:$="Matrix2fv";break;case 35675:$="Matrix3fv";break;case 35676:$="Matrix4fv"}if(-1===$.indexOf("Matrix")&&v>1&&($+="v",D=1),"M"===$.charAt(0)){t(u,".uniform",$,"(",g,",");var k=Math.pow(m-35674+2,2),C=e.global.def("new Float32Array(",k,")");Array.isArray(p)?t("false,(",c(k,function(e){return C+"["+e+"]="+p[e]}),",",C,")"):t("false,(Array.isArray(",p,")||",p," instanceof Float32Array)?",p,":(",c(k,function(e){return C+"["+e+"]="+p+"["+e+"]"}),",",C,")"),t(");")}else if(D>1){for(var T=[],S=[],F=0;F<D;++F)Array.isArray(p)?S.push(p[F]):S.push(t.def(p+"["+F+"]")),f&&T.push(t.def());f&&t("if(!",e.batchId,"||",T.map(function(e,t){return e+"!=="+S[t]}).join("||"),"){",T.map(function(e,t){return e+"="+S[t]+";"}).join("")),t(u,".uniform",$,"(",g,",",S.join(","),");"),f&&t("}")}else{if(f){var O=t.def();t("if(!",e.batchId,"||",O,"!==",p,"){",O,"=",p,";")}t(u,".uniform",$,"(",g,",",p,");"),f&&t("}")}}}function U(e,t,r,n){var i,a,f,o,u,s=e.shared,c=s.gl,l=s.draw,$=n.draw,p=(o=$.elements,u=t,o?((o.contextDep&&n.contextDynamic||o.propDep)&&(u=r),f=o.append(e,u),$.elementsActive&&u("if("+f+")"+c+".bindBuffer(34963,"+f+".buffer.buffer);")):(f=u.def(),u(f,"=",l,".",eB,";","if(",f,"){",c,".bindBuffer(",34963,",",f,".buffer.buffer);}","else if(",s.vao,".currentVAO){",f,"=",e.shared.elements+".getElements("+s.vao,".currentVAO.elements);",A?"":"if("+f+")"+c+".bindBuffer(34963,"+f+".buffer.buffer);","}")),f);function d(i){var a=$[i];return a?a.contextDep&&n.contextDynamic||a.propDep?a.append(e,r):a.append(e,t):t.def(l,".",i)}var h,m,v,x=d(ez),b=d(eI),g=(m=$.count,v=t,m?((m.contextDep&&n.contextDynamic||m.propDep)&&(v=r),h=m.append(e,v)):h=v.def(l,".",ej),h);if("number"==typeof g){if(0===g)return}else r("if(",g,"){"),r.exit("}");y&&(i=d(eP),a=e.instancing);var _=p+".type",w=$.elements&&tt($.elements)&&!$.vaoActive;function D(){function e(){r(a,".drawElementsInstancedANGLE(",[x,g,_,b+"<<(("+_+"-5121)>>1)",i],");")}function t(){r(a,".drawArraysInstancedANGLE(",[x,b,g,i],");")}p&&"null"!==p?w?e():(r("if(",p,"){"),e(),r("}else{"),t(),r("}")):t()}function E(){function e(){r(c+".drawElements("+[x,g,_,b+"<<(("+_+"-5121)>>1)"]+");")}function t(){r(c+".drawArrays("+[x,b,g]+");")}p&&"null"!==p?w?e():(r("if(",p,"){"),e(),r("}else{"),t(),r("}")):t()}y&&("number"!=typeof i||i>=0)?"string"==typeof i?(r("if(",i,">0){"),D(),r("}else if(",i,"<0){"),E(),r("}")):D():E()}function G(e,t,r,n,i){var a=P(),f=a.proc("body",i);return y&&(a.instancing=f.def(a.shared.extensions,".angle_instanced_arrays")),e(a,f,r,n),a.compile().body}function Y(e,t,r,n){W(e,t),r.useVAO?r.drawVAO?t(e.shared.vao,".setVAO(",r.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),N(e,t,r,n.attributes,function(){return!0})),q(e,t,r,n.uniforms,function(){return!0},!1),U(e,t,t,r)}function X(e,t,r,n){function i(){return!0}e.batchId="a1",W(e,t),N(e,t,r,n.attributes,i),q(e,t,r,n.uniforms,i,!1),U(e,t,t,r)}function J(e,t,r,n){W(e,t);var i=r.contextDep,a=t.def(),f=t.def();e.shared.props=f,e.batchId=a;var o=e.scope(),u=e.scope();function s(e){return e.contextDep&&i||e.propDep}function c(e){return!s(e)}if(t(o.entry,"for(",a,"=0;",a,"<","a1",";++",a,"){",f,"=","a0","[",a,"];",u,"}",o.exit),r.needsContext&&L(e,u,r.context),r.needsFramebuffer&&R(e,u,r.framebuffer),H(e,u,r.state,s),r.profile&&s(r.profile)&&Q(e,u,r,!1,!0),n)r.useVAO?r.drawVAO?s(r.drawVAO)?u(e.shared.vao,".setVAO(",r.drawVAO.append(e,u),");"):o(e.shared.vao,".setVAO(",r.drawVAO.append(e,o),");"):o(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(o(e.shared.vao,".setVAO(null);"),N(e,o,r,n.attributes,c),N(e,u,r,n.attributes,s)),q(e,o,r,n.uniforms,c,!1),q(e,u,r,n.uniforms,s,!0),U(e,o,u,r);else{var l=e.global.def("{}"),$=r.shader.progVar.append(e,u),p=u.def($,".id"),d=u.def(l,"[",p,"]");u(e.shared.gl,".useProgram(",$,".program);","if(!",d,"){",d,"=",l,"[",p,"]=",e.link(function(t){return G(X,e,r,t,2)}),"(",$,");}",d,".call(this,a0[",a,"],",a,");")}}function K(e,t,r){var n=t.static[r];if(n&&function e(t){if(!("object"!=typeof t||V(t))){for(var r=Object.keys(t),n=0;n<r.length;++n)if(a.isDynamic(t[r[n]]))return!0;return!1}}(n)){var i=e.global,f=Object.keys(n),o=!1,u=!1,s=!1,c=e.global.def("{}");f.forEach(function(t){var r=n[t];if(a.isDynamic(r)){"function"==typeof r&&(r=n[t]=a.unbox(r));var f=tn(r,null);o=o||f.thisDep,s=s||f.propDep,u=u||f.contextDep}else{switch(i(c,".",t,"="),typeof r){case"number":i(r);break;case"string":i('"',r,'"');break;case"object":Array.isArray(r)&&i("[",r.join(),"]");break;default:i(e.link(r))}i(";")}}),t.dynamic[r]=new a.DynamicVariable(4,{thisDep:o,contextDep:u,propDep:s,ref:c,append:function e(t,r){f.forEach(function(e){var i=n[e];if(a.isDynamic(i)){var f=t.invoke(r,i);r(c,".",e,"=",f,";")}})}}),delete t.static[r]}}return{next:E,current:D,procs:function(){var e,t=P(),r=t.proc("poll"),n=t.proc("refresh"),a=t.block();r(a),n(a);var o=t.shared,u=o.gl,s=o.next,l=o.current;a(l,".dirty=false;"),R(t,r),R(t,n,null,!0),y&&(e=t.link(y)),i.oes_vertex_array_object&&n(t.link(i.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var $=0;$<f.maxAttributes;++$){var p=n.def(o.attributes,"[",$,"]"),d=t.cond(p,".buffer");d.then(u,".enableVertexAttribArray(",$,");",u,".bindBuffer(",34962,",",p,".buffer.buffer);",u,".vertexAttribPointer(",$,",",p,".size,",p,".type,",p,".normalized,",p,".stride,",p,".offset);").else(u,".disableVertexAttribArray(",$,");",u,".vertexAttrib4f(",$,",",p,".x,",p,".y,",p,".z,",p,".w);",p,".buffer=null;"),n(d),y&&n(e,".vertexAttribDivisorANGLE(",$,",",p,".divisor);")}return n(t.shared.vao,".currentVAO=null;",t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"),Object.keys(C).forEach(function(e){var i=C[e],f=a.def(s,".",e),o=t.block();o("if(",f,"){",u,".enable(",i,")}else{",u,".disable(",i,")}",l,".",e,"=",f,";"),n(o),r("if(",f,"!==",l,".",e,"){",o,"}")}),Object.keys(S).forEach(function(e){var i,f,o=S[e],$=D[e],p=t.block();if(p(u,".",o,"("),V($)){var d=$.length;i=t.global.def(s,".",e),f=t.global.def(l,".",e),p(c(d,function(e){return i+"["+e+"]"}),");",c(d,function(e){return f+"["+e+"]="+i+"["+e+"];"}).join("")),r("if(",c(d,function(e){return i+"["+e+"]!=="+f+"["+e+"]"}).join("||"),"){",p,"}")}else i=a.def(s,".",e),f=a.def(l,".",e),p(i,");",l,".",e,"=",i,";"),r("if(",i,"!==",f,"){",p,"}");n(p)}),t.compile()}(),compile:function t(r,a,f,s,$){var h=P();h.stats=h.link($),Object.keys(a.static).forEach(function(e){K(h,a,e)}),eG.forEach(function(e){K(h,r,e)});var m=function e(t,r,a,f,s){t.static,t.dynamic;var $,h,m,v,x,y,w,A,D,E,C,S,O,B,z=function e(t,r){var n=t.static;if("string"==typeof n[e7]&&"string"==typeof n[eV]){if(Object.keys(r.dynamic).length>0)return null;var i=r.static,a=Object.keys(i);if(a.length>0&&"number"==typeof i[a[0]]){for(var f=[],o=0;o<a.length;++o)f.push([0|i[a[o]],a[o]]);return f}}return null}(t,r),j=function e(t,r){var n=t.static,i=t.dynamic;if(e5 in n){var a=n[e5];return a?(a=l.getFramebuffer(a),tr(function(e,t){var r=e.link(a),n=e.shared;t.set(n.framebuffer,".next",r);var i=n.context;return t.set(i,"."+eM,r+".width"),t.set(i,"."+eH,r+".height"),r})):tr(function(e,t){var r=e.shared;t.set(r.framebuffer,".next","null");var n=r.context;return t.set(n,"."+eM,n+"."+eq),t.set(n,"."+eH,n+"."+eU),"null"})}if(!(e5 in i))return null;var f=i[e5];return tn(f,function(e,t){var r=e.invoke(t,f),n=e.shared,i=n.framebuffer,a=t.def(i,".getFramebuffer(",r,")");t.set(i,".next",a);var o=n.context;return t.set(o,"."+eM,a+"?"+a+".width:"+o+"."+eq),t.set(o,"."+eH,a+"?"+a+".height:"+o+"."+eU),a})}(t,s),I=function e(t,r,n){var i=t.static,a=t.dynamic;function f(e){if(e in i){var t,n,f=i[e],o=!0,u=0|f.x,s=0|f.y;return"width"in f?t=0|f.width:o=!1,"height"in f?n=0|f.height:o=!1,new te(!o&&r&&r.thisDep,!o&&r&&r.contextDep,!o&&r&&r.propDep,function(e,r){var i=e.shared.context,a=t;"width"in f||(a=r.def(i,".",eM,"-",u));var o=n;return"height"in f||(o=r.def(i,".",eH,"-",s)),[u,s,a,o]})}if(e in a){var c=a[e],l=tn(c,function(e,t){var r=e.invoke(t,c),n=e.shared.context,i=t.def(r,".x|0"),a=t.def(r,".y|0"),f=t.def('"width" in ',r,"?",r,".width|0:","(",n,".",eM,"-",i,")"),o=t.def('"height" in ',r,"?",r,".height|0:","(",n,".",eH,"-",a,")");return[i,a,f,o]});return r&&(l.thisDep=l.thisDep||r.thisDep,l.contextDep=l.contextDep||r.contextDep,l.propDep=l.propDep||r.propDep),l}return r?new te(r.thisDep,r.contextDep,r.propDep,function(e,t){var r=e.shared.context;return[0,0,t.def(r,".",eM),t.def(r,".",eH)]}):null}var o=f(eF);if(o){var u=o;o=new te(o.thisDep,o.contextDep,o.propDep,function(e,t){var r=u.append(e,t),n=e.shared.context;return t.set(n,"."+eW,r[2]),t.set(n,"."+eQ,r[3]),r})}return{viewport:o,scissor_box:f(eS)}}(t,j,s),P=function e(t,r){var n=t.static,i=t.dynamic,a={},f=!1,o=function e(){if("vao"in n){var t=n.vao;return null!==t&&null===p.getVAO(t)&&(t=p.createVAO(t)),f=!0,a.vao=t,tr(function(e){var r=p.getVAO(t);return r?e.link(r):"null"})}if("vao"in i){f=!0;var r=i.vao;return tn(r,function(e,t){var n=e.invoke(t,r);return t.def(e.shared.vao+".getVAO("+n+")")})}return null}(),s=!1,c=function e(){if(eB in n){var t=n[eB];if(a.elements=t,eZ(t)){var r=a.elements=u.create(t,!0);t=u.getElements(r),s=!0}else t&&(t=u.getElements(t),s=!0);var c=tr(function(e,r){if(t){var n=e.link(t);return e.ELEMENTS=n,n}return e.ELEMENTS=null,null});return c.value=t,c}if(eB in i){s=!0;var l=i[eB];return tn(l,function(e,t){var r=e.shared,n=r.isBufferArgs,i=r.elements,a=e.invoke(t,l),f=t.def("null"),o=t.def(n,"(",a,")"),u=e.cond(o).then(f,"=",i,".createStream(",a,");").else(f,"=",i,".getElements(",a,");");return t.entry(u),t.exit(e.cond(o).then(i,".destroyStream(",f,");")),e.ELEMENTS=f,f})}return f?new te(o.thisDep,o.contextDep,o.propDep,function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.elements+".getElements("+e.shared.vao+".currentVAO.elements):null")}):null}();function l(e,t){if(e in n){var r=0|n[e];return t?a.offset=r:a.instances=r,tr(function(e,n){return t&&(e.OFFSET=r),r})}if(e in i){var u=i[e];return tn(u,function(e,r){var n=e.invoke(r,u);return t&&(e.OFFSET=n),n})}if(t){if(s)return tr(function(e,t){return e.OFFSET=0,0});if(f)return new te(o.thisDep,o.contextDep,o.propDep,function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.offset:0")})}else if(f)return new te(o.thisDep,o.contextDep,o.propDep,function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.instances:-1")});return null}var $=l(eI,!0),d=function e(){if(ez in n){var t=n[ez];return a.primitive=t,tr(function(e,r){return T[t]})}if(ez in i){var r=i[ez];return tn(r,function(e,t){var n=e.constants.primTypes,i=e.invoke(t,r);return t.def(n,"[",i,"]")})}return s?tt(c)?c.value?tr(function(e,t){return t.def(e.ELEMENTS,".primType")}):tr(function(){return 4}):new te(c.thisDep,c.contextDep,c.propDep,function(e,t){var r=e.ELEMENTS;return t.def(r,"?",r,".primType:",4)}):f?new te(o.thisDep,o.contextDep,o.propDep,function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.primitive:4")}):null}(),h=function e(){if(ej in n){var t=0|n[ej];return a.count=t,tr(function(){return t})}if(ej in i){var r=i[ej];return tn(r,function(e,t){return e.invoke(t,r)})}if(s){if(tt(c))return c?$?new te($.thisDep,$.contextDep,$.propDep,function(e,t){return t.def(e.ELEMENTS,".vertCount-",e.OFFSET)}):tr(function(e,t){return t.def(e.ELEMENTS,".vertCount")}):tr(function(){return -1});return new te(c.thisDep||$.thisDep,c.contextDep||$.contextDep,c.propDep||$.propDep,function(e,t){var r=e.ELEMENTS;return e.OFFSET?t.def(r,"?",r,".vertCount-",e.OFFSET,":-1"):t.def(r,"?",r,".vertCount:-1")})}return f?new te(o.thisDep,o.contextDep,o.propDep,function(e,t){return t.def(e.shared.vao,".currentVAO?",e.shared.vao,".currentVAO.count:-1")}):null}();return{elements:c,primitive:d,count:h,instances:l(eP,!1),offset:$,vao:o,vaoActive:f,elementsActive:s,static:a}}(t,s),L=(E=t,S=E.static,O=E.dynamic,B={},k.forEach(function(e){var t=F(e);function r(r,n){if(e in S){var i=r(S[e]);B[t]=tr(function(){return i})}else if(e in O){var a=O[e];B[t]=tn(a,function(e,t){return n(e,t,e.invoke(t,a))})}}switch(e){case ey:case ep:case e$:case e4:case ev:case eT:case eA:case eD:case e2:case eg:return r(function(e){return e},function(e,t,r){return r});case ex:return r(function(e){return eX[e]},function(e,t,r){var n=e.constants.compareFuncs;return t.def(n,"[",r,"]")});case eb:return r(function(e){return e},function(e,t,r){var n=t.def("+",r,"[0]"),i=t.def("+",r,"[1]");return[n,i]});case em:return r(function(e){var t="srcRGB"in e?e.srcRGB:e.src,r="srcAlpha"in e?e.srcAlpha:e.src,n="dstRGB"in e?e.dstRGB:e.dst,i="dstAlpha"in e?e.dstAlpha:e.dst;return[eY[t],eY[n],eY[r],eY[i]]},function(e,t,r){var n=e.constants.blendFuncs;function i(e,n){return t.def('"',e,n,'" in ',r,"?",r,".",e,n,":",r,".",e)}var a=i("src","RGB"),f=i("dst","RGB"),o=t.def(n,"[",a,"]"),u=t.def(n,"[",i("src","Alpha"),"]"),s=t.def(n,"[",f,"]"),c=t.def(n,"[",i("dst","Alpha"),"]");return[o,s,u,c]});case eh:return r(function(e){return"string"==typeof e?[g[e],g[e]]:"object"==typeof e?[g[e.rgb],g[e.alpha]]:void 0},function(e,t,r){var n=e.constants.blendEquations,i=t.def(),a=t.def(),f=e.cond("typeof ",r,'==="string"');return f.then(i,"=",a,"=",n,"[",r,"];"),f.else(i,"=",n,"[",r,".rgb];",a,"=",n,"[",r,".alpha];"),t(f),[i,a]});case ed:return r(function(e){return c(4,function(t){return+e[t]})},function(e,t,r){return c(4,function(e){return t.def("+",r,"[",e,"]")})});case eE:return r(function(e){return 0|e},function(e,t,r){return t.def(r,"|0")});case ek:return r(function(e){var t=e.cmp||"keep",r=e.ref||0,n="mask"in e?e.mask:-1;return[eX[t],r,n]},function(e,t,r){var n=e.constants.compareFuncs,i=t.def('"cmp" in ',r,"?",n,"[",r,".cmp]",":",7680),a=t.def(r,".ref|0"),f=t.def('"mask" in ',r,"?",r,".mask|0:-1");return[i,a,f]});case e8:case eC:return r(function(t){var r=t.fail||"keep",n=t.zfail||"keep",i=t.zpass||"keep";return[e===eC?1029:1028,eJ[r],eJ[n],eJ[i]]},function(t,r,n){var i=t.constants.stencilOps;function a(e){return r.def('"',e,'" in ',n,"?",i,"[",n,".",e,"]:",7680)}return[e===eC?1029:1028,a("fail"),a("zfail"),a("zpass")]});case e3:return r(function(e){var t;return[0|e.factor,0|e.units]},function(e,t,r){var n=t.def(r,".factor|0"),i=t.def(r,".units|0");return[n,i]});case ew:return r(function(e){var t=0;return"front"===e?t=1028:"back"===e&&(t=1029),t},function(e,t,r){return t.def(r,'==="front"?',1028,":",1029)});case e6:return r(function(e){return e},function(e,t,r){return r});case e0:return r(function(e){return eK[e]},function(e,t,r){return t.def(r+'==="cw"?2304:2305')});case e_:return r(function(e){return e.map(function(e){return!!e})},function(e,t,r){return c(4,function(e){return"!!"+r+"["+e+"]"})});case e1:return r(function(e){var t;return["value"in e?e.value:1,!!e.invert]},function(e,t,r){var n=t.def('"value" in ',r,"?+",r,".value:1"),i=t.def("!!",r,".invert");return[n,i]})}}),B),R=function e(t,r,i){var a,f=t.static,o=t.dynamic;function u(e){if(e in f){var t=n.id(f[e]),r=tr(function(){return t});return r.id=t,r}if(e in o){var i=o[e];return tn(i,function(e,t){var r=e.invoke(t,i);return t.def(e.shared.strings,".id(",r,")")})}return null}var s=u(e7),c=u(eV),l=null;return tt(s)&&tt(c)?(l=d.program(c.id,s.id,null,i),a=tr(function(e,t){return e.link(l)})):a=new te(s&&s.thisDep||c&&c.thisDep,s&&s.contextDep||c&&c.contextDep,s&&s.propDep||c&&c.propDep,function(e,t){var r,n,i=e.shared.shader;r=s?s.append(e,t):t.def(i,".",e7),n=c?c.append(e,t):t.def(i,".",eV);var a=i+".program("+n+","+r;return t.def(a+")")}),{frag:s,vert:c,progVar:a,program:l}}(t,s,z);function M(e){var t=I[e];t&&(L[e]=t)}M(eF),M(F(eS));var H,W,Q,N,q,U=Object.keys(L).length>0,G={framebuffer:j,draw:P,shader:R,state:L,dirty:U,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(G.profile=function e(t){var r,n=t.static,i=t.dynamic;if(eO in n){var a=!!n[eO];(r=tr(function(e,t){return a})).enable=a}else if(eO in i){var f=i[eO];r=tn(f,function(e,t){return e.invoke(t,f)})}return r}(t,s),G.uniforms=(Q=(H=a).static,N=H.dynamic,q={},Object.keys(Q).forEach(function(e){var t,r=Q[e];if("number"==typeof r||"boolean"==typeof r)t=tr(function(){return r});else if("function"==typeof r){var n=r._reglType;"texture2d"===n||"textureCube"===n?t=tr(function(e){return e.link(r)}):("framebuffer"===n||"framebufferCube"===n)&&(t=tr(function(e){return e.link(r.color[0])}))}else V(r)&&(t=tr(function(e){return e.global.def("[",c(r.length,function(e){return r[e]}),"]")}));t.value=r,q[e]=t}),Object.keys(N).forEach(function(e){var t=N[e];q[e]=tn(t,function(e,r){return e.invoke(r,t)})}),q),G.drawVAO=G.scopeVAO=P.vao,!G.drawVAO&&R.program&&!z&&i.angle_instanced_arrays&&P.static.elements){var Y=!0,X=R.program.attributes.map(function(e){var t=r.static[e];return Y=Y&&!!t,t});if(Y&&X.length>0){var J=p.getVAO(p.createVAO({attributes:X,elements:P.static.elements}));G.drawVAO=new te(null,null,null,function(e,t){return e.link(J)}),G.useVAO=!0}}return z?G.useVAO=!0:G.attributes=($=r,m=$.static,v=$.dynamic,x={},Object.keys(m).forEach(function(e){var t=m[e],r=n.id(e),i=new b;if(eZ(t))i.state=1,i.buffer=o.getBuffer(o.create(t,34962,!1,!0)),i.type=0;else{var a=o.getBuffer(t);if(a)i.state=1,i.buffer=a,i.type=0;else if("constant"in t){var f=t.constant;i.buffer="null",i.state=2,"number"==typeof f?i.x=f:el.forEach(function(e,t){t<f.length&&(i[e]=f[t])})}else{a=eZ(t.buffer)?o.getBuffer(o.create(t.buffer,34962,!1,!0)):o.getBuffer(t.buffer);var u=0|t.offset,s=0|t.stride,c=0|t.size,l=!!t.normalized,$=0;"type"in t&&($=_[t.type]);var p=0|t.divisor;i.buffer=a,i.state=1,i.size=c,i.normalized=l,i.type=$||a.dtype,i.offset=u,i.stride=s,i.divisor=p}}x[e]=tr(function(e,t){var n=e.attribCache;if(r in n)return n[r];var a={isStream:!1};return Object.keys(i).forEach(function(e){a[e]=i[e]}),i.buffer&&(a.buffer=e.link(i.buffer),a.type=a.type||a.buffer+".dtype"),n[r]=a,a})}),Object.keys(v).forEach(function(e){var t=v[e];x[e]=tn(t,function e(r,n){var i=r.invoke(n,t),a=r.shared,f=r.constants,o=a.isBufferArgs,u=a.buffer,s={isStream:n.def(!1)},c=new b;c.state=1,Object.keys(c).forEach(function(e){s[e]=n.def(""+c[e])});var l=s.buffer,$=s.type;function p(e){n(s[e],"=",i,".",e,"|0;")}return n("if(",o,"(",i,")){",s.isStream,"=true;",l,"=",u,".createStream(",34962,",",i,");",$,"=",l,".dtype;","}else{",l,"=",u,".getBuffer(",i,");","if(",l,"){",$,"=",l,".dtype;",'}else if("constant" in ',i,"){",s.state,"=",2,";","if(typeof "+i+'.constant === "number"){',s[el[0]],"=",i,".constant;",el.slice(1).map(function(e){return s[e]}).join("="),"=0;","}else{",el.map(function(e,t){return s[e]+"="+i+".constant.length>"+t+"?"+i+".constant["+t+"]:0;"}).join(""),"}}else{","if(",o,"(",i,".buffer)){",l,"=",u,".createStream(",34962,",",i,".buffer);","}else{",l,"=",u,".getBuffer(",i,".buffer);","}",$,'="type" in ',i,"?",f.glTypes,"[",i,".type]:",l,".dtype;",s.normalized,"=!!",i,".normalized;"),p("size"),p("offset"),p("stride"),p("divisor"),n("}}"),n.exit("if(",s.isStream,"){",u,".destroyStream(",l,");","}"),s})}),x),G.context=(w=(y=f).static,A=y.dynamic,D={},Object.keys(w).forEach(function(e){var t=w[e];D[e]=tr(function(e,r){return"number"==typeof t||"boolean"==typeof t?""+t:e.link(t)})}),Object.keys(A).forEach(function(e){var t=A[e];D[e]=tn(t,function(e,r){return e.invoke(r,t)})}),D),G}(r,a,f,s,h);return!function e(t,r){var n=t.proc("draw",1);W(t,n),L(t,n,r.context),R(t,n,r.framebuffer),M(t,n,r),H(t,n,r.state),Q(t,n,r,!1,!0);var i=r.shader.progVar.append(t,n);if(n(t.shared.gl,".useProgram(",i,".program);"),r.shader.program)Y(t,n,r,r.shader.program);else{n(t.shared.vao,".setVAO(null);");var a=t.global.def("{}"),f=n.def(i,".id"),o=n.def(a,"[",f,"]");n(t.cond(o).then(o,".call(this,a0);").else(o,"=",a,"[",f,"]=",t.link(function(e){return G(Y,t,r,e,1)}),"(",i,");",o,".call(this,a0);"))}Object.keys(r.state).length>0&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}(h,m),!function e(t,r){var i=t.proc("scope",3);t.batchId="a2";var a=t.shared,f=a.current;function o(e){var n=r.shader[e];n&&i.set(a.shader,"."+e,n.append(t,i))}L(t,i,r.context),r.framebuffer&&r.framebuffer.append(t,i),e9(Object.keys(r.state)).forEach(function(e){var n=r.state[e].append(t,i);V(n)?n.forEach(function(r,n){i.set(t.next[e],"["+n+"]",r)}):i.set(a.next,"."+e,n)}),Q(t,i,r,!0,!0),[eB,eI,ej,eP,ez].forEach(function(e){var n=r.draw[e];n&&i.set(a.draw,"."+e,""+n.append(t,i))}),Object.keys(r.uniforms).forEach(function(e){var f=r.uniforms[e].append(t,i);Array.isArray(f)&&(f="["+f.join()+"]"),i.set(a.uniforms,"["+n.id(e)+"]",f)}),Object.keys(r.attributes).forEach(function(e){var n=r.attributes[e].append(t,i),a=t.scopeAttrib(e);Object.keys(new b).forEach(function(e){i.set(a,"."+e,n[e])})}),r.scopeVAO&&i.set(a.vao,".targetVAO",r.scopeVAO.append(t,i)),o(eV),o(e7),Object.keys(r.state).length>0&&(i(f,".dirty=true;"),i.exit(f,".dirty=true;")),i("a1(",t.shared.context,",a0,",t.batchId,");")}(h,m),!function e(t,r){var n=t.proc("batch",2);t.batchId="0",W(t,n);var i=!1,a=!0;Object.keys(r.context).forEach(function(e){i=i||r.context[e].propDep}),i||(L(t,n,r.context),a=!1);var f=r.framebuffer,o=!1;function u(e){return e.contextDep&&i||e.propDep}f?(f.propDep?i=o=!0:f.contextDep&&i&&(o=!0),o||R(t,n,f)):R(t,n,null),r.state.viewport&&r.state.viewport.propDep&&(i=!0),M(t,n,r),H(t,n,r.state,function(e){return!u(e)}),r.profile&&u(r.profile)||Q(t,n,r,!1,"a1"),r.contextDep=i,r.needsContext=a,r.needsFramebuffer=o;var s=r.shader.progVar;if(s.contextDep&&i||s.propDep)J(t,n,r,null);else{var c=s.append(t,n);if(n(t.shared.gl,".useProgram(",c,".program);"),r.shader.program)J(t,n,r,r.shader.program);else{n(t.shared.vao,".setVAO(null);");var l=t.global.def("{}"),$=n.def(c,".id"),p=n.def(l,"[",$,"]");n(t.cond(p).then(p,".call(this,a0,a1);").else(p,"=",l,"[",$,"]=",t.link(function(e){return G(J,t,r,e,2)}),"(",c,");",p,".call(this,a0,a1);"))}}Object.keys(r.state).length>0&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}(h,m),e(h.compile(),{destroy:function(){m.shader.program.destroy()}})}}}(i,F,P,eL,eR,eN,tl,tp,{},ts,tc,ei,en,L,n),th=function e(t,r,n,i,a,f,o){function u(e){a=null===r.next?5121:r.next.colorAttachments[0].texture._texture.type;var a,f=0,o=0,u=i.framebufferWidth,s=i.framebufferHeight,c=null;h(e)?c=e:e&&(f=0|e.x,o=0|e.y,u=0|(e.width||i.framebufferWidth-f),s=0|(e.height||i.framebufferHeight-o),c=e.data||null),n();var l=u*s*4;return c||(5121===a?c=new Uint8Array(l):5126===a&&(c=c||new Float32Array(l))),t.pixelStorei(3333,4),t.readPixels(f,o,u,s,6408,a,c),c}return function e(t){var n,i;return t&&"framebuffer"in t?(n=t,r.setFBO({framebuffer:n.framebuffer},function(){i=u(n)}),i):u(t)}}(i,tp,td.procs.poll,en,l,P,eL),tm=td.next,tv=i.canvas,tx=[],tb=[],tg=[],t_=[n.onDestroy],ty=null;function tw(){if(0===tx.length){L&&L.update(),ty=null;return}ty=f.next(tw),tk();for(var e=tx.length-1;e>=0;--e){var t=tx[e];t&&t(en,null,0)}i.flush(),L&&L.update()}function t0(){!ty&&tx.length>0&&(ty=f.next(tw))}function t6(){ty&&(f.cancel(tw),ty=null)}function tA(e){e.preventDefault(),$=!0,t6(),tb.forEach(function(e){e()})}function t3(e){i.getError(),$=!1,b.restore(),tc.restore(),eR.restore(),tl.restore(),t$.restore(),tp.restore(),ts.restore(),L&&L.restore(),td.procs.refresh(),t0(),tg.forEach(function(e){e()})}function tD(t){function r(e,t){var r={},n={};return Object.keys(e).forEach(function(i){var f=e[i];if(a.isDynamic(f)){n[i]=a.unbox(f,i);return}if(t&&Array.isArray(f)){for(var o=0;o<f.length;++o)if(a.isDynamic(f[o])){n[i]=a.unbox(f,i);return}}r[i]=f}),{dynamic:n,static:r}}var n=r(t.context||{},!0),i=r(t.uniforms||{},!0),f=r(t.attributes||{},!1),o=r(function t(r){var n=e({},r);function i(e){if(e in n){var t=n[e];delete n[e],Object.keys(t).forEach(function(r){n[e+"."+r]=t[r]})}}return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),i("blend"),i("depth"),i("cull"),i("stencil"),i("polygonOffset"),i("scissor"),i("sample"),"vao"in r&&(n.vao=r.vao),n}(t),!1),u={gpuTime:0,cpuTime:0,count:0},s=td.compile(o,f,i,n,u),c=s.draw,l=s.batch,$=s.scope,p=[];return e(function e(t,r){var n;if("function"==typeof t)return $.call(this,null,t,0);if("function"==typeof r){if("number"==typeof t)for(n=0;n<t;++n)$.call(this,null,r,n);else if(!Array.isArray(t))return $.call(this,t,r,0);else for(n=0;n<t.length;++n)$.call(this,t[n],r,n)}else if("number"==typeof t){if(t>0)return l.call(this,function e(t){for(;p.length<t;)p.push(null);return p}(0|t),0|t)}else if(!Array.isArray(t))return c.call(this,t);else if(t.length)return l.call(this,t,t.length)},{stats:u,destroy:function(){s.destroy()}})}tv&&(tv.addEventListener(tf,tA,!1),tv.addEventListener(to,t3,!1));var t2=tp.setFBO=tD({framebuffer:a.define.call(null,1,"framebuffer")});function t1(e,t){var r=0;td.procs.poll();var n=t.color;n&&(i.clearColor(+n[0]||0,+n[1]||0,+n[2]||0,+n[3]||0),r|=16384),"depth"in t&&(i.clearDepth(+t.depth),r|=256),"stencil"in t&&(i.clearStencil(0|t.stencil),r|=1024),i.clear(r)}function t4(e){return tx.push(e),t0(),{cancel:function t(){var r=tu(tx,e);function n(){tx[tu(tx,n)]=tx[tx.length-1],tx.length-=1,tx.length<=0&&t6()}tx[r]=n}}}function tE(){var e=tm.viewport,t=tm.scissor_box;e[0]=e[1]=t[0]=t[1]=0,en.viewportWidth=en.framebufferWidth=en.drawingBufferWidth=e[2]=t[2]=i.drawingBufferWidth,en.viewportHeight=en.framebufferHeight=en.drawingBufferHeight=e[3]=t[3]=i.drawingBufferHeight}function tk(){en.tick+=1,en.time=tC(),tE(),td.procs.poll()}function t8(){tl.refresh(),tE(),td.procs.refresh(),L&&L.update()}function tC(){return(o()-Q)/1e3}t8();var tT=e(tD,{clear:function t(r){if("framebuffer"in r){if(r.framebuffer&&"framebufferCube"===r.framebuffer_reglType)for(var n=0;n<6;++n)t2(e({framebuffer:r.framebuffer.faces[n]},r),t1);else t2(r,t1)}else t1(null,r)},prop:a.define.bind(null,1),context:a.define.bind(null,2),this:a.define.bind(null,3),draw:tD({}),buffer:function(e){return eR.create(e,34962,!1,!1)},elements:function(e){return eN.create(e,!1)},texture:tl.create2D,cube:tl.createCube,renderbuffer:t$.create,framebuffer:tp.create,framebufferCube:tp.createCube,vao:ts.createVAO,attributes:l,frame:t4,on:function e(t,r){var n;switch(t){case"frame":return t4(r);case"lost":n=tb;break;case"restore":n=tg;break;case"destroy":n=t_}return n.push(r),{cancel:function(){for(var e=0;e<n.length;++e)if(n[e]===r){n[e]=n[n.length-1],n.pop();return}}}},limits:eL,hasExtension:function(e){return eL.extensions.indexOf(e.toLowerCase())>=0},read:th,destroy:function e(){tx.length=0,t6(),tv&&(tv.removeEventListener(tf,tA),tv.removeEventListener(to,t3)),tc.clear(),tp.clear(),t$.clear(),ts.clear(),tl.clear(),eN.clear(),eR.clear(),L&&L.clear(),t_.forEach(function(e){e()})},_gl:i,_refresh:t8,poll:function(){tk(),L&&L.update()},now:tC,stats:I});return n.onDone(null,tT),tT}});